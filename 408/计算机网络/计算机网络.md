[toc]

# 1 概述

## 1.1 因特网概述

### 1.1.1 网络、互联网和因特网

- 网络（Network）由若干<strong style="color:red">结点</strong>（Node）和连接这些结点的<strong style="color:red">链路</strong>（Link）组成。
- 多个网络还可以和路由器互连起来，这样就构成了一个覆盖范围更大的网络，即互联网。因此，互联网可以称为是<strong style="color:red"> "网络的网络"</strong> （Network of Network）
- 因特网（Internet）是世界上最大的互连网络

<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230205234032433.png" alt="image-20230205234032433" style="zoom: 25%;" />

> :warning:**注意：区分 `internet` 和 `Internet`**
>
> - `internet` 是一个通用名词，它泛指由多个计算机网络互连而成的网络，在这些网络之间的通信协议可以是任意的
> - `Internet` 是一个专用名词，指代当前全球最大的、开放的、由众多网络相互连接而成的特定计算机网络，它采用 <u>TCP / IP 协议簇</u>作为通信的规则，前身是美国的 APRANET





### 1.1.2 因特网发展的三个阶段 

其他的后面补充。

1983 年，TCP / IP 协议称为 APRANET 的标准协议，这也是因特网诞生的时间



**基于 ISP 的三层结构的因特网**

<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230205235056183.png" alt="image-20230205235056183" style="zoom:25%;" />

- 第一层 ISP 通常也被称为因特网主干网，通常都能覆盖国际性区域范围，并且拥有高速链路和交换设备，第一层 ISP 之间直接互连
- 第二层 ISP 和一些大公司都是第一层 ISP 的用户，具有区域性和国家性覆盖范围，与少数 ISP 直接相连
- 第三层 ISP 是第二层 ISP 的用户，并且只拥有本地范围的网络，例如：校园网、企业网

> :spiral_notepad:**备注：如果某个用户能够接入互联网，那么他只需要购买一些如调制解调器或路由器这样的设备即可成为一个 ISP**



### 1.1.3 标准化工作



### 1.1.4 因特网的组成

因特网的组成

1. 边缘部分：由所有连接在因特网上的<strong style="color:red">主机</strong>组成，这部分是<strong style='color:red'>用户直接使用</strong>的，用来<strong style="color:red">通信和资源共享</strong>
2. 核心部分：由<strong style="color:red">大量网络和连接这些网络的路由器</strong>组成，这部分是<strong style="color:red">为边缘部分提供服务</strong>的（提供连通性和交换）



## 1.2 三种交换方式

在计算机网络中，一共有三种交换方式，分别是：

- 电路交换（Circuit Switching）
- 报文交换（）
- 分组交换（Packet Switching）

### 1.2.1 电路交换

我们如果想要连通两部电话，只需要通过电话线将其连接即可，但是一旦电话数量增多，那么就需要非常多的电话线，例如 n 部电话之间想要实现两两相互连通，那么就需要 $\frac{n(n-1)}{2}$ 根电话线，这显然是极大地浪费资源，这时候我们就需要考虑电路交换。

![image-20230206110516361](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230206110516361.png)

- 电话交换机接通电话线的方式称为电路交换
- 从通信资源的分配角度看，交换（Switching）就是按照某种方式动态地分配传输线路的资源

<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230206111938507.png" alt="image-20230206111938507" style="zoom:50%;" />

- 用户到交换机之间的用户线是用户独享的
- 交换机与交换机之间的中继线是用户共享的

电话交换的三个步骤：

1. 建立连接（分配通信资源）
2. 通话（一直占用通信资源）
3. 释放连接（归还通信资源）

![image-20230206123747293](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230206123747293.png)

简述流程：在使用电路交换打电话之前，必须先拨号请求建立连接，当被叫用户听到电路交换机送来的拨号音并摘机后，从主叫端到被叫端就建立了一条连接，也就是一条专用的物理通路，这条连接保证了双方通话所需的通信资源，并且这些资源在双方通信时不会被其他用户占用，之后就是主叫与被叫之间相互通话，这段时间会一直占用通信资源，直到挂断后才会将占用的通信资源归还给电信网。

```
当使用电路交换来传送计算机数据时，其线路的传输效率很低，如果用户正在输入或编辑一份在线文档，此时通信资源一直未被使用，同时别人也无法使用，造成极大的浪费
```



### 1.2.2 分组交换

<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230206134725357.png" alt="image-20230206134725357" style="zoom: 25%;" />

例如：假设 H6 的用户要给 H2 的用户发送一段报文，在发送报文之前会先将较长的报文划分为一个个更小的等长数据段，在每个数据段前加上由控制信息组成的首部后就构成了一个分组，也可简称为 "包"，相应地，首部也可以称为 "包头"，各分组经过途中各分组交换机的存储转发，最终到达主机 H2，主机 H2 收到分组后，去掉首部，将各数据段组合还原成原始报文。

**各部分的主要工作**

- 发送方：构造分组；发送分组
- 路由器：缓存分组；转发分组
- 接收方：接收分组、还原报文

分组交换和报文交换类似，它们的交换结点都采用存储转发方式，但<strong style="color:red">报文交换对报文的大小没有限制，这就要求交换结点需要具有较大的缓存空间</strong>



### 1.2.3 电路交换、报文交换、分组交换三者的对比

<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230206141039641.png" alt="image-20230206141039641" style="zoom:50%;" />

- 报文交换、分组交换相较电路交换，在传送报文时，不需要事先建立连接，可以随时转发分组
- 报文交换由于不限制报文大小，要求节点交换机拥有较大的缓存空间，全部存储下来之后进行查表转发
- 对于分组交换，节点交换机<u>在发送分组时，还会缓存接收到的分组</u>，分组交换相较于报文交换，<strong style="color:red">减少了转发时延，还可以避免过长的报文长时间占用链路，同时也有利于进行差错控制</strong>

![image-20230206143206995](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230206143206995.png)



## 1.3 计算机网络的定义和分类

计算机网络的精确定义并未统一。

计算机网络最简单的定义：一些<strong style="color:red">互连、自治</strong>的计算机的<strong style="color:red">集合</strong>

- 互连：是指计算机之间可以通过有线或无线的方式进行数据通信
- 自治：是指独立的计算机，它拥有自己的硬件和软件，可以单独运行使用
- 集合：是指至少需要两台计算机



**计算机网络的分类**

1. 按交换技术分类：电路交换网络、报文交换网络、分组交换网络
2. 按使用者分类：公用网、专用网
3. 按传输介质分类：有线网络、无线网络
4. 按覆盖范围分类：广域网WAN、城域网MAN、局域网LAN、个人网PAN
5. 按拓扑结构分类：总线型网络、星型网络、环型网络、网状型网络



## 1.4 计算机网络性能指标

性能指标可以从不同的方面来度量计算机网络性能

常用的计算机网络的性能指标有以下 8 个：

> 扩展知识：在我们日常生活会发现，厂商给出的 U 盘标注的大小和操作系统中实际大小不同，那是因为产商上大小基数是 $10^3$，而操作系统上的基数是 $2^{10}$ 

1. 速率：连接在计算机网络上的主机<strong style="color:red">在数字信道上传送比特的速率</strong>，也称为比特率或者数据率，单位为 bit/s、b/s 或 bps

   > $1\ kbps = 10^3\ bps,\ 1\ Mbps = 10^3\ kbps, \ 1\ Gbps = 10^3\ Mbps$

2. 带宽：

   - 带宽在<u>模拟信号系统</u>中的意义：信号所包含的各种不同频率成分所占据的**频率范围**，单位为：Hz（kHz、MHz、GHz）
   - 带宽在计算机网络中的意义：用来表示网络的**通信线路**所能传送数据的能力，因此网络带宽表示在单位时间内从网络的某一点到另一点能通过的 "**最高数据率**"

3. 吞吐量：表示在<strong style='color:red'>单位时间内通过某个网络（或信道、接口）的数据量</strong>

   > 吞吐量受网络带宽或额定速率的限制

4. 时延

5. 时延带宽积：$传播时延 \times 带宽$ 

   > 链路的时延带宽积又称为以比特为单位的链路长度

6. 往返时间

   在多数情况下，因特网上的信息不仅仅是单向传输，而是双向交互；如果我们需要知道双向交互一次所需的时间，可以使用往返时间RTT（Round-Trip Time）也是一个重要的性能指标

7. 利用率：分为信道利用率和网络利用率

   - 信道利用率：用来展示某信道有百分之几的时间是被利用的
   - 网络利用率：全网络的信道利用率的加权平均
   - 根据排队论，当某信道的利用率增大时，该信道引起的时延也会迅速增加，因而，信道利用率并非越高越好
   - 如果我们用 $D_0$ 表示网络空闲的时延，$D$ 表示当前网络的时延，利用率用 $U$ 表示，则它们之间的关系式为：$D=\frac{D_0}{1-U}$，一般拥有较大主干网的 ISP 会控制它们的信道利用率不超过 50%，因为超过这个界限，时延会急剧增大

8. 丢包率：即分组丢失率，是指在一定时间范围内，传输过程中<strong style='color:red'>丢失的分组数量与总分组数量的比率</strong>，产生丢包的两种情况：

   - 分组在传输过程中出现误码，被结点丢弃
   - 分组到达一台队列已满的分组交换机时被丢弃



**01 时延**

<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230206163538867.png" alt="image-20230206163538867" style="zoom:50%;" />

- **发送时延**：也叫传输时延，是<strong style="color:red">源主机将分组的比特推向链路所花费的时间</strong>

- **传播时延**：<strong style="color:red">分组的电信号在链路上传输所花费的时间</strong>

- **处理时延**：<strong style="color:red">路由器收到分组后，对其进行存储转发所花费的时间</strong>

  > - 这里将排队时延和处理时延统称为处理时延
  > - 在主机之间分组的传输过程中，通常具有多个传播时延和处理时延







**例1：**有一个待发送的数据块，大小为 100 MB，网卡的发送速率为 100 Mbps，则网卡发送完该数据块需要多长时间？
$$
\frac{100 M B}{100 M b / s}=\frac{M B}{M b / s}=\frac{2^{20} B}{10^6 \mathrm{~b} / \mathrm{s}}=\frac{2^{20} \cdot 8 \mathrm{~b}}{10^6 \mathrm{~b} / \mathrm{s}}=8.388608 \mathrm{~s}
$$
但是在平时估算时，`M` 可以直接约掉，最终结果为 8s，与答案相差不大

**例1**

主机甲通过 1 个路由器(存储转发方式)与主机乙互联，两段链路的数据传输速率均为 $10Mbps$，主机甲分别采用报文交换和分组大小为 $10kb$ 的分组交换向主机乙发送 1 个大小为 $8Mb(1M=10^6$) 的报文。若忽略链路传播延迟、分组头开销和分组拆装时间，则两种交换方式完成该报文传输所需的总时间分别为（ **D** ）
A．800ms、1600ms

B．801ms、1600ms

C．1600ms、800ms 

D．1600ms、801ms

答：

报文交换：整个报文一齐传输，从源主机发送到链路所花费的时间为：$\frac{8 \times 10^6}{10 \times 10^6} = 0.8s = 800ms$，算上目的主机接收该报文的时间，一共是 $1600ms$

分组交换：单个分组发送到链路所花费的时间为：$\frac{10 \times 10^3}{10 \times 10^6} = 0.001s=1ms$，一共有 800 个分组，并且当第二个分组发送完毕后，第一个分组已成功被接受，以此类推，可知一共花费的时间为 $801ms$

**例2**

<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230206165213916.png" alt="image-20230206165213916" style="zoom:50%;" />



## 1.5 计算机网络体系结构

<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230206173537021.png" alt="image-20230206173537021" style="zoom:50%;" />

- TCP / IP 体系结构将物理层和数据链路层合并为网络接口层，并将网络层改为网际层，去除了表示层和会话层
- OSI 七层模型由于制作周期长，存在冗余的部分，运行效率低等原因而被市场抛弃，而 TCP / IP 体系结构更加适合商业化标准



![image-20230206173440633](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230206173440633.png)

- 路由器一般只包含网络接口层和网际层
- TCP / IP 体系结构的网络接口层并没有规定具体的内容，使得可以互连全世界不同的网络接口，例如：有线的以太网接口、无线局域网的 WIFI 接口，而不限制仅使用一种或几种网络接口。因而，本质上 TCP / IP 体系结构只有上面的三层

<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230219164920006.png" alt="image-20230219164920006" style="zoom:50%;" />

1. 物理层：使用低电频代表 0，使用高电频代表 1
2. 数据链路层：
3. 网络层：标识各网络以及网络中的各主机，像IP 地址（例如：198.168.1.0）的前三位来标识当前主机所处的网络，后一位标识当前主机；使用路由选择算法来计算最适合的路线
4. 运输层：解决进程之间基于网络的通信以及出现传输错误时的错误处理



## 1.6 专业术语

- 实体：任何可发送或接收信息的<strong style="color:red">硬件或软件进程</strong>

  > 对等实体：通信双方相同层次中的实体

- 协议：控制两个对等实体进行逻辑通信的规则的集合

  <img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230206200008158.png" alt="image-20230206200008158" style="zoom:50%;" />

- 服务：在协议的控制下，两个对等实体间的逻辑通信能够向上提供服务

  - 服务访问点：在同一系统中相邻两层的实体交换信息的逻辑窗口
    - 数据链路层的服务访问点为 "帧"
    - 网络层的服务访问点为 IP 数据报首部的 "协议字段"
    - 运输层的服务访问点为 "端口号"
  - 服务原语：上层使用下层所提供的服务必须通过与下层交换一些命令，这些命令称为服务原语

  <img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230206204441480.png" alt="image-20230206204441480" style="zoom:50%;" />

  - 协议数据单元 PDU：<strong style="color:red">对等层次之间传送的数据包</strong>称为该层的协议数据单元

  - 服务数据单元 SDU：<strong style="color:red">同一系统内，层与层之间交换的数据包</strong>为服务数据单元

    > 多个 SDU 可以合成一个 PDU；一个 SDU 也可以划分为几个 PDU

    ![image-20230206205149270](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230206205149270.png)

    



:herb:**扩展：协议三要素**

- 语法：定义所交换信息的格式（即字段的长度与位置）

  <img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230219171119491.png" alt="image-20230219171119491" style="zoom:25%;" />

- 语义：定义通信双发所要完成的工作

- 同步：定义通信双方的时序关系





# 2 应用层

## 2.1 应用层概述

应用层是计算机网络体系结构中的<strong style="color:red">最顶层</strong>，是<strong style="color:red">设计和建立计算机网络的最终目的</strong>，也是计算机网络中发展最快的部分。

- 早期基于文本的应用（电子邮件、远程登录、文件传输、新闻组）
- 20 世纪 90 年代将因特网带入千家万户的万维网 WWW
- 当今流行的即时通信、P2P文件共享以及各种音频应用



## 2.2 客户—服务器方式和对等方式

网络应用程序运行在处于网络边缘的不同的端系统上，通过彼此的通信来共同完成某项任务。

开发一种新的网络应用程序首先要考虑的问题就是：<strong style="color:red">网络应用程序在各种端系统上的组织方式和它们之间的关系</strong>，目前流行的主有以下两种：

- 客户 / 服务器（Client / Server，C / S）方式
- 对等（Peer-to-Peer，P2P）方式

### 2.2.1 客户服务器方式

- 客户和服务器是指通信中所涉及的两个应用进程
- 客户 / 服务器方式所描述的是进程之间服务与被服务的关系
- <strong style="color:red">客户是服务请求方，服务器是服务提供方</strong>
- <strong style="color:red">服务器总是处于运行状态，被动地等待客户的服务请求。服务器具有固定端口号（例如：HTTP 服务器的默认端口号为 80），而运行服务器的主机也具有固定的 IP 地址</strong>

<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230206212139537.png" alt="image-20230206212139537" style="zoom:50%;" />

- C / S 方式是因特网上传统的、同时也最成熟的方式，很多我们熟悉的网络应用采用的都是 C / S 方式。包括万维网WWW、电子邮件、文件传输 FTP等
- 基于 C / S 方式的应用服务通常是<strong style="color:red">服务集中型</strong>的，即应用服务集中在网络中比客户计算机少得多的服务器计算机上
  - 由于一台服务器计算机要为多个客户机提供服务，在 C / S 应用中，常会出现<strong style="color:red">服务器计算机跟不上众多客户机请求的情况</strong>
  - 为此，常用<strong style="color:red">计算机群集（或服务器场）构建一个强大的虚拟服务器</strong>



### 2.2.2 对等方式

在 P2P 方式中，<strong style="color:red">没有固定的服务器请求和服务提供者</strong>，分布在网络边缘各端系统中的应用进程是对等的，被称为对等方，<strong style="color:red">对等方相互之间直接通信</strong>，每个对等方既是服务请求者，又是服务提供者。

> 目前，在因特网上流行的 P2P 应用主要包括 <u>P2P 文件共享、即时通信、P2P 流媒体、分布式存储</u>等

- 基于 P2P 的应用是<strong style="color:red">服务分散型</strong>的，因为服务不是集中在少数几个服务器计算机中，而是分散在大量对等计算机中，这些计算机并不为服务提供商所有
- P2P 方式最突出的特性之一就是它的<strong style="color:red">可扩展性</strong>。因为系统每增加一个对等方，不仅增加的是服务的请求者，同时也增加了服务的提供者，<strong style="color:red">系统性能不会因规模的增大而降低</strong>
- P2P 方式具有成本上的巨大优势



## 2.3 动态主机配置协议 DHCP（Dynamic Host Configuration Protocol）

为了使得用户主机能够正常访问 Web 服务器，需要对用户主机配置如下相关信息：

- IP 地址
- 子网掩码
- 默认网关
- DNS 服务器

而这些配置如果我们手动设置，那么工作量大且极容易出错，所以这时需要在网络总添加一台 DHCP 服务器，在该服务器中设置好可为其他网络中各主机配置的网络配置信息，网络中各主机开机后自动启动 DHCP 程序，向 DHCP 服务器请求自己的网络配置信息，这样网络中各主机就可以从 DHCP 服务器中自动获取网络配置信息

<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230206225747178.png" alt="image-20230206225747178" style="zoom:50%;" />

DHCP 是位于 TCP / IP 体系结构中的应用层协议，它使用下层 UDP 提供的服务，也就是说 DHCP 报文会在运输层被封装成 UDP 用户数据报文段，<strong style="color:red">DHCP 服务器所使用的 UDP 端口是 67，DHCP 客户所使用的的 UDP 端口是 68</strong>

**DHCP 客户与 DHCP 服务器的交互过程**

1. 当启动主机的 DHCP 应用程序后，DHCP 客户将广播发送 DHCP 发现报文（DHCP DISCOVER），封装该报文的 IP 数据包的源 IP 地址为 0.0.0.0，目的地址为 255.255.255.255

   >- 由于主机目前还未分配到 IP 地址，所以使用 0.0.0.0 替代
   >
   >- 目的地址为广播地址 255.255.255.255 ，使用广播发送的原因是：目前主机还不知道网络中有哪些 DHCP 服务器，也不知道它们对应的 IP 地址

2. 由于是通过广播发送的 IP 数据报，因此，网络中所有设备都会收到该 IP 数据包，并对其层层解封，解封出封装有 DHCP 发现报文的 UDP 用户数据报，对于 DHCP 客户，其应用层没有监听该 UDP 用户数据报目的端口 67 的进程，因此无法交付 DHCP 发现报文，只能丢弃；对于 DHCP 服务器，其应用层运行时刻监听 UDP 用户数据报目的端口号 67 的进程，因此会接收该 DHCP 发现报文并做出响应

   > DHCP 报文比较复杂，我们只需要知道其内部封装有事务 ID 和 DHCP客户端的 MAC 地址

3. DHCP 服务端根据其中封装的 DHCP 客户端的 MAC 地址来查找自己的数据库是否有对应的配置信息，如果有，则使用这些配置信息来构建并发送 <u>DHCP 提供报文</u>（DHCP OFFER），如果没有，则使用默认的配置信息来构建并发送 DHCP 提供报文

   > - 封装该报文的 IP 数据报的源 IP 地址为 DHCP 服务器的 IP 地址，目的地址依然为广播地址
   > - 依然使用广播地址的原因：主机目前还没有配置 IP 地址

4. 网络中所有设备都会收到该 IP 数据报，并对其层层解封，解封出封装有 DHCP 提供报文的 UDP 用户数据报，只有 DHCP 客户拥有监听 UDP 数据报目的端口号 68 的进程，会接收该 DHCP 提供报文并作出相应处理，DHCP 客户会根据 DHCP 提供报文中的事务 ID 来判断该报文是否是自己所请求的报文，如果是则接收，否则丢弃

   > - 提供报文中还包含 IP 地址、子网掩码、地址租期、默认网关、DNS 服务器等配置信息
   > - 同时 DHCP 服务器会从自己的 IP 地址池中挑选待租用给主机的 IP 地址时，会使用 ARP 确保所选的 IP 地址未被网络中其他主机占用

5. DHCP 客户选择好 IP 地址后，会向所选的 DHCP 服务器发送 <u>DHCP 请求报文</u>

   > - 封装该报文的 IP 数据报的源 IP 地址仍为 0.0.0.0 ，目的 IP 地址仍为广播地址
   > - DHCP 请求报文中拥有事务 ID 以及 DHCP 客户端的 MAC 地址，接受租约中的 IP地址，并提供此租约的 DHCP 服务器的 IP 地址

6. DHCP 服务器接受该请求后，DHCP 服务器会发送 DHCP 确认报文给 DHCP 客户端

![image-20230207002937997](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230207002937997.png)

7. 之后当租用期过了一半时，DHCP 客户端会发送 DHCP 请求报文来请求更新租用期

   <img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230207003406261.png" alt="image-20230207003406261" style="zoom:50%;" />



**DHCP 中继代理**

![image-20230207003709007](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230207003709007.png)



<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230219213130691.png" alt="image-20230219213130691" style="zoom:50%;" />

## 2.4 域名系统 DNS

DNS 的全称为 "Domain Name System"，[其底层使用的是]() TCP 报文

DNS 的作用：用于将域名转换为IP地址

- 因特网采用层次树状结构的域名结构

- 域名的结构由若干个分量组成，各分量之间用 "点" 隔开，代表不同级别的域名

  ```
  ….三级域名.二级域名.顶级域名
  ```

  - 每一级的域名都是由英文字母和数字组成，不超过 63 个字符，不区分大小写
  - 级别最低的域名写在最左边，级别高的域名写在最右边
  - 一个完整的域名不超过 255 个字符

- 域名系统既不规定一个域名需要包含多少个下级域名，也不规定每一级域名代表什么意思

- 各级域名由其上一级的域名管理机构管理，而最高的顶级域名则由因特网名称与数字地址分配机构 ICANN 进行管理





顶级域名 TLD（Top Level Domain）分为以下三类：

- 国家顶级域名 nTLD：cn 代表中国，us 代表美国，uk 代表英国等等
- 通用顶级域名 gTLD：最常见的通用顶级域名有 7 个，分别为，com（公司企业）、net（网络服务机构）、org（非营利性组织）、int（国际组织）、edu（美国教育机构）、gov（美国政府部门）、mil（美国军事部门）
- 反向域 arpa：用于反向域名解析，即 IP 地址反向解析为域名



:warning:**注意**：<strong style="color:red">在国家顶级域名下注册的二级域名均由国家自行确定。</strong>例如，顶级域名为 jp 的日本，将其教育和企业机构的二级域名定义为 ac 和 co，而不用 edu 和 com，而我国则将二级域名划分为以下两类：

- 类别域名：共七个。ac（科研机构）、com（工、商、金融等企业）、edu（教育机构）、gov（政府部分）、net（提供网络服务的机构）、mil（军事机构）和 org（非营利组织）
- 行政区域名：共 34 个，适用于我国的各省、自治区、直辖市。例如，bj 为北京市、sh 为上海市、js 为江苏省



:herb:**举例：因特网的域名空间**

<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230208163059633.png" alt="image-20230208163059633" style="zoom:50%;" />

> 备注：这种按等级管理的命名方法便于维护名字的唯一性，并且也容易设计出一种高效的域名查询机制。需要注意的是，域名只是一个逻辑概念，并不代表计算机所在的物理地点



### 2.4.1 域名服务器的分类

1. 域名和 IP 地址的映射关系必须保存在域名服务器中，供所有其他应用查询。显然不能将所有的信息都存放在一台域名服务器上，DNS 使用<strong style="color:red">分布在各地的域名服务器来实现域名到 IP 地址的转换</strong>
2. 域名服务器可以划分为以下四种不同的类型：
   - 根域名服务器：最高层次的域名服务器，每个根域名服务器都知道所有的顶级域名服务器的域名及其 IP 地址。因特网上拥有 <strong style="color:red">13</strong> 个不同 IP 地址的根域名服务器，每个根域名服务器其实是由中许多计算机构成的<strong style="color:red">服务器群集</strong>。<strong style="color:red">根域名服务器通常不直接对域名进行解析，而是返回该域名所属顶级域名的顶级域名服务器的 IP 地址</strong>
   - 顶级域名服务器：负责管理在该顶级域名服务器下注册的所有二级域名
   - 权限域名服务器：这些域名服务器<strong style="color:red">管理某个区的域名</strong>，权限域名服务器知道其管辖的域名与 IP 地址的映射关系，还知道其下级域名服务器的地址
   - 本地域名服务器：也称为默认域名服务器，本地域名服务器不属于上述的域名服务器的等级结构。本地域名服务器起着代理的作用，会将本地主机的 DNS 请求报文转发到上述的域名服务器的等级结构中

### 2.4.2 域名解析的过程

域名解析的方式主要分为两种：递归查询和迭代查询

![image-20230208165759394](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230208165759394.png)

> 注意：由于递归查询对于被查询的域名服务器负担太大，通常采用如下模式：从请求主机到本地域名服务器的查询是递归查询，而其余查询是迭代查询



:herb:**扩展**

为了<u>提高了 DNS 的查询效率，并减轻根域名服务器的负荷和减少因特网上的 DNS 查询报文的数量</u>，在域名服务器中广泛地使用了<strong style="color:red">高速缓存</strong>。高速缓存用来存放最近查询过的域名以及从何处获取域名映射信息的记录。

对于高速缓存的内容：

- 由于 IP 地址与域名的映射关系并不是永久不变的，为了保持告诉缓存中的内容正确，<strong style="color:red">域名服务器应为高速缓存的的内容设置计时器并删除超过合理时间的项</strong>
- 除了域名服务器，用户主机同样也需要设置高速缓存来维护自己最近使用过的域名对应的 IP 地址



:pencil2:**习题1**

<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230208171902218.png" alt="image-20230208171902218" style="zoom:50%;" />



:pencil2:**习题2**

<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230208172323178.png" alt="image-20230208172323178" style="zoom:50%;" />



### 2.4.3 文件传送协议 FTP

将某台计算机中的文件通过网络传送到可能相距很远的另一台计算机中，是一项基本的网络应用，即文件传送。

文件传送协议（File Transfer Protocol）是因特网上使用最广泛的文件传送的协议。

- FTP 提供<strong style="color:red">交互式的访问</strong>，允许客户指明文件的类型与格式（如：是否使用 ASCII 码），并允许文件具有存取权限（如访问文件的用户必须经过授权，并输入有效的口令）
- FTP <strong style="color:red">屏蔽了各计算机系统细节</strong>，因而适合于在异构网络中任意计算机之间传送文件



**ftp 常见命令**

```bash
# 连接 FTP 服务器
ftp ip地址	

# 连接成功后进入 FTP 服务器
# 列出 FTP 服务器当前目录下的所有文件和文件夹
ftp> dir

# 从 FTP 服务器下载文件
ftp> get fileName

# 向 FTP 服务器中上传文件
ftp> put fileName
```



**FTP 常见用途**

- 在计算机之间传输，尤其是用于批量传输文件
- 让网站设计者将构成网站内容的大量文件批量上传到他们的 Web 服务器



**FTP 的基本工作原理**

<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230208193725994.png" alt="image-20230208193725994" style="zoom:50%;" />

- 在**主动模式**下：FTP 服务器监听熟知端口号 21，FTP 客户随机选择一个临时端口号与其建立 TCP 连接，该连接用于给 FTP 服务器与 FTP 客户传送 FTP 相关的控制命令。

  - 当有数据要传输时，FTP 客户通过命令通道告知 FTP 服务器来与自己的另一个临时端口号建立 TCP 连接，即建立数据通道。（此时，FTP 服务器使用自己的熟知端口号 20 来与其建立 TCP 连接）
  - 由于在建立通道时，FTP 服务器主动连接 FTP 客户，因此称为主动模式

  > :warning:**注意：控制连接在整个会话期间一直保持打开，用于传送 FTP 相关的控制命令，而数据连接用于文件传输，在每次文件传输时才建立，传输结束就关闭**

- 在**被动模式**下：FTP 服务器与 FTP 客户端对于命令通道的建立与主动模式没有区别，不同之处在于，当有数据要传输时，FTP 客户通过命令通道通知  FTP 服务器开启某个协商好的临时端口，FTP 服务器被动等待来自 FTP 客户的 TCP 连接以建立数据通道。

  - 由于在 FTP 建立数据通道时，FTP 服务器被动等待 FTP 客户的连接，因此称为被动模式



**总结**

- 主动模式：客户端向FTP服务器发送端口信息，由服务器主动连接该端口；
- 被动模式：FTP服务器开启并发送端口信息给客户端，由客户端连接该端口，服务器被动接受连接。

:pencil2:**习题**

<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230208202115082.png" alt="image-20230208202115082" style="zoom:50%;" />



<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230208202212514.png" alt="image-20230208202212514" style="zoom:50%;" />



## 2.5 电子邮件

电子邮件（E-mail）是因特网上<strong style="color:red">最早流行</strong>的一种应用，并且在当今时代仍然是因特网上最重要、最实用的应用之一。

传统的电话通信属于实时通信，存在以下两个缺点：

1. 电话通信的主叫和被叫双方必须同时在场
2. 一些不是十分紧迫的电话也常常不必要地打断人们的工作或休息

而电子邮件与邮政系统的寄信相似：

1. 发件人将邮件发送到自己使用的邮件服务器
2. 发件人的邮件服务器将收到的邮件按其目的地址转发到收件人邮件服务器中的收件人的邮箱
3. 收件人在方便的时候访问收件人邮件服务器中自己的邮箱，获取收到的电子邮件

电子邮件的优点：

1. 使用方便、传递迅速
2. 价格低廉
3. 文本信息丰富，不仅可以传送文件信息，还可以附上音频和图像



### 2.5.1 电子邮件基础介绍

- 电子邮件系统采用<strong style='color:red'> 客户 / 服务器方式</strong>
- 电子邮件系统的三个主要组成构件：<strong style="color:red">用户代理、邮件服务器，以及电子邮件所需的协议</strong>
  - **用户代理**是用户与电子邮件的接口，又称为**电子邮件客户端软件**
  - **邮件服务器**是电子邮件系统的基础设施，因特网上所有的 ISP 都有邮件服务器，其功能就是**发送和接收邮件**，同时还要负责维护用户的邮箱
  - 协议包括**邮件发送协议（例如：SMTP）和邮件读取协议（例如：POP3、IMAP）**

<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230208204825950.png" alt="image-20230208204825950" style="zoom:50%;" />



### 2.5.2 邮件发送和接收过程

<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230208210315878.png" alt="image-20230208210315878" style="zoom:50%;" />

过程：发送方的 SMTP 用户代理作为 SMTP 客户，与发送方邮件服务器中的 SMTP 服务器进行 TCP 连接，使用 SMTP 协议发送邮件到 SMTP 服务器；发送方邮件服务器中的 SMTP 客户与接收方邮件服务器中的 SMTP 服务器进行 TCP 连接，然后基于这条 TCP 连接，使用 SMTP 协议来发送已收到的待转发邮件给接收方的邮件服务器；接收方的用户代理作为 POP3 客户，与接收方邮件服务器中的 POP3 邮件服务器进行 TCP 连接，基于这条连接使用 POP3 协议读取邮件



### 2.5.3 电子邮件工作原理

简单邮件传送协议 SMTP（Simple Mail Transfer Protocol）的基本工作原理：

<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230208213048068.png" alt="image-20230208213048068" style="zoom:50%;" />



### 2.5.4 电子邮件信息格式

电子邮件的格式并不是由 SMTP 定义的，而是 RFC 822 单独定义的。这个 RFC 文档已在 2008 年更新为 RFC 5322.一个电子邮件有<strong style="color:red">信封和内容</strong>两部分，而内容又由<strong style="color:red">首部和主体</strong>两部分构成

<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230208214638162.png" alt="image-20230208214638162" style="zoom:50%;" />

- `CC` 为 "Carbon Copy"（抄送），`BCC` 为 "Blind Carbon Copy"（暗抄送）
- 两者的区别在：BCC 栏的收件人可以看到所有收件人名（TO、CC、BCC），而 TO 和 CC 栏的收件人看不到 CC 的收件人



### 2.5.5 MIME

**引入：为什么要加入 MIME **

MIME 是**多用途因特网邮件扩展**，全称为 "Multipurpose Internet Mail Extensions"。由于 **SMTP 协议只能传送 ASCII 码文本数据**，不能传送可执行文件或其他二进制对象，也不能传送多媒体和其他国家字符，因此提出了 MIME 来解决这一问题。

![image-20230208220248649](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230208220248649.png)

MIME 对传送的 SMTP 做出的改变：

1. 增加了<strong style="color:red"> 5 个新的邮件首部字段</strong>，提供了有关邮件主体的信息
2. 定义了<strong style="color:red">许多邮件内容的格式</strong>，对多媒体电子邮件的表示方法进行了标准化
3. 定义了<strong style="color:red">传送编码</strong>，可对任何内容格式进行转换，而不会被邮件系统改变

> 实际上，MIME 不仅仅可以用于 SMTP，也用于后来同样面对 ASCII 字符 的 HTTP



### 2.5.6 邮件读取协议

常用的邮件读取协议有以下两个：

1. 邮件协议 POP（Post Office Protocol）：POP3 是其第三个版本，是因特网正式标准。
   - 简单、功能有限的邮件读取协议
   - 用户只能以<strong style="color:red">下载并删除方式方式</strong>，或者<strong style="color:red">下载并保留方式</strong>从邮件服务器下载邮件到用户计算机，不允许用户在邮件服务器上管理自己的邮件
2. 因特网邮件访问协议（Internet Message Access Protocol），IMAP4 是其第四个版本，目前还只是因特网建议标准
   - 功能比 POP3 强大，用户在自己计算机上就可以操控邮件服务器中的邮箱，就像在本地操控一样，因此 IMAP 就是一个联机协议

> POP3 和 IMAP 都采用基于 TCP 连接的客户 / 服务器方式。POP3 使用熟知端口 110，IMAP4 使用熟知端口 143



### 2.5.7 基于万维网的电子邮件

基于万维网的电子邮件，即 WebMail:

- 通过浏览器登录（提供用户名和口令）邮件服务器万维网网站就可以撰写、收发、阅读和管理电子邮件，这种工作模式与 IMAP 类似，不同的是用户计算机无需安装专门的用户代理程序，只需要使用通用的万维网浏览器即可。
- 邮件服务器网站，例如：新浪邮箱、谷歌邮箱，通常都提供非常强大和方便的邮件管理功能，用户可以在邮件服务器网站上管理和处理自己的邮件，而不需要将邮件下载到本地

<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230208230311950.png" alt="image-20230208230311950" style="zoom:50%;" />



### 2.5.8 习题

![image-20230208230422792](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230208230422792.png)





![image-20230208230559384](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230208230559384.png)





## 2.6 WWW万维网

### 2.6.1 万维网的介绍

- 万维网WWW（World Wide Web）并非某种特殊的计算机网络。它是一个大规模、联机式的信息储藏所，是<strong style="color:red">运行在因特网上的一个分布式应用</strong>
- 万维网利用网页之间的<strong style="color:red">超链接</strong>将不同的网站的网页链接成一张逻辑上的信息网



目前比较流行的浏览器如下：

<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230208232242637.png" alt="image-20230208232242637" style="zoom:50%;" />

> 目前 IE 已经被淘汰，微软将其替换成为 Edge

浏览器最重要的部分是<strong style="color:red">渲染引擎</strong>，也就是<strong style="color:red">浏览器内核</strong>，**负责对网页内容进行解析和显示**

为了方便地访问在世界范围的文档，万维网使用<strong style="color:red">统一资源定位符 URL</strong> 来指明因特网上任何种类 "资源" 的位置。URL 的组成形式如下：
$$
<协议>://<主机>:<端口>/<路径>
$$


### 2.6.2 超文本传输协议 HTTP（HyperText Transfer Protocol）

HTTP 定义了浏览器（即万维网客户进程）<u>怎样向万维网服务器请求万维网文档，以及万维网服务器怎样把万维网文档传送给浏览器</u>

<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230208235010985.png" alt="image-20230208235010985" style="zoom:50%;" />



### 2.6.3 HTTP 版本

HTTP/1.0 采用<strong style="color:red">非持续连接</strong>方式。在该方式下，每次浏览器请求一个文件都要与服务器建立 TCP 连接。当收到响应后就立即关闭连接。

- 每请求一个文档就要有两倍的 RTT 的开销。若一个网页上有很多引用对象（例如图片等），那么请求每一个对象都要花费 2RTT 时间
- 为了减小时延，浏览器通常会建立多个并行的 TCP 连接同时请求多个对象，但是，这会大量占用万维网服务器的资源，特别是万维网服务器往往要同时服务大量客户的请求，这会使得负担很重

![image-20230208235343992](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230208235343992.png)



HTTP/1.1 采用<strong style="color:red">持续连接</strong>的方式。在该方式下，万维网服务器在发送响应报文后仍然会保持这条连接，使得同一个客户（浏览器）和该服务器可以继续在这条连接上传送后续的 HTTP 请求报文和响应报文，这不局限于传送同一个页面上引用的对象，而是只要这些文档都是在同一个服务器上即可

- 为了进一步提高效率，HTTP / 1.1 的持续连接还可以使用<strong style="color:red">流水线</strong>的工作方式，即浏览器在收到 HTTP 的响应报文之前就能够连续发送多个请求报文，这样的一个接一个的请求报文到达服务器后，服务器就发回一个接一个的响应报文，节省了很多个 RTT 时间，使得 TCP 连接中的空闲时间减少，提高文档下载的效率



### 2.6.4 HTTP 报文格式

HTTP 是<strong style="color:red">面向文本</strong>的，其报文中的每一个字段都是一些 ASCII 码串，并且<strong style="color:red">每个字段的长度都是不确定的</strong>

1. **请求的报文格式**

   <img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230209002433609.png" alt="image-20230209002433609" style="zoom:50%;" />

2. **响应的报文格式**

   <img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230209003348857.png" alt="image-20230209003348857" style="zoom:50%;" />

**响应报文中常见的状态行**

1. `HTTP/1.1 202 Accepted`：接受请求
2. `HTTP/1.1 400 Bad Request`：错误的请求
3. `HTTP/1.1 404 Not Found`：找不到页面



### 2.6.5 Cookie

- 早期的万维网应用非常简单，仅仅是用户查看存放在不同服务器上的各种静态的文档。因此 HTTP 被设计为一种<strong style="color:red">无状态</strong>的协议，这样可以简化服务器的设计
- 现在，用户可以通过万维网实现各种复杂应用，例如网上购物、电子商务，这就需要万维网服务能够识别用户
- Cookie 提供了一种存储机制，使得万维网可以"记住"用户，而无需用户重复提交用户标识信息，也就是，<strong style="color:red">Cookie 是一种将无状态的 HTTP 进行状态化的技术</strong>

![image-20230209005210854](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230209005210854.png)



### 2.6.6 万维网缓存和代理服务器

- 在万维网中还可以使用缓存机制提高万维网的效率
- 万维网缓存又称为 <strong style="color:red">Web 缓存（Web Cache）</strong>，可位于客户机上，也可位于中间系统上，位于中间系统上的 Web 缓存又称为<strong style="color:red">代理服务器（Proxy Server）</strong>
- Web 缓存把最近的一些请求和响应暂存在本地磁盘中。当新请求到达时，若发现这个请求与暂时存放的请求相同，就返回暂存的响应，而不需要按 URL 的地址再次去因特网上访问该资源

![image-20230209114119787](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230209114119787.png)

> 若 Web 缓存的命中率比较高，那么就会大大减少了该链路上的通信量，因而减少了访问因特网的时延



:thinking:**疑问：若是原始服务器中某文档已修改，但是代理服务器中保存的该文档副本是旧版本，那么此时主机上请求到的文档和原始服务器上的文档不一致，这种情况如何解决？**

解决方法：

原始服务器会为每一个响应的对象设定一个修改时间字段（Last-Modified）和一个有效日期字段（Expires）

当校园网中的某台主机要请求原始服务器中的该文档时，会首先向校园网中的代理服务器发起请求

- 若代理服务器中该文档未过期，则代理服务器将其封装在响应报文中发送给主机；

  <img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230209120436362.png" alt="image-20230209120436362" style="zoom:50%;" />

- 若代理服务器中该文档已过期，则代理服务器会向因特网上的原始服务器发送请求，在请求报文的首部字段中包含一个 `if-modified-since` 的首部行（该字段的取值就是该文档的修改日期 `Last-Modified`），原始服务器根据文档的修改日期就可判断出代理服务器中存储的该文档是否与自己存储的文档一致

  - 若一致，则给代理服务器发送不包含实体主体的响应

    <img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230209120951242.png" alt="image-20230209120951242" style="zoom:50%;" />

    代理服务器收到响应报文后，更新该文档的有效期（Expires）

  - 若不一致，则代理服务器发送封装有该文档的响应报文，代理服务器再收到响应后，将更新后的该文档封装在响应报文中发回主机

    <img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230209121219007.png" alt="image-20230209121219007" style="zoom:50%;" />





### 2.6.7 习题

![image-20230209124923467](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230209124923467.png)



![image-20230209125105881](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230209125105881.png)



# 3 运输层

- 计算机体系结构中的<u>物理层、数据链路层以及网络层</u>它们共同解决了将主机通过异构网络互联起来的面临的问题，实现了<strong style="color:red">主机到主机的通信。</strong>
- 但实际上在计算机网络中进行<strong style="color:red">通信的真正实体是位于通信两端主机中的进程</strong>
- 如何为运行在不同主机上的应用进程进提供直接的通信服务是运输层的任务，运输层协议又称为端到端协议

<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230209141247028.png" alt="image-20230209141247028" style="zoom:50%;" />

![image-20230209141524075](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230209141524075.png)



## 3.1 运输层端口号、复用与分用

- 运行在计算机上的进程使用 <strong style="color:red">进程标识符 PID </strong>来标志

- 因特网上的计算机并不是使用统一的操作系统，不同的操作系统（Windows、Linux、Mac）又<strong style="color:red">使用不同的格式的进程标识符</strong>

- 为了使运行在不同操作系统的计算机应用进程之间能够进行网络通信，就必须<strong style="color:red">使用统一的方法对 TCP / IP 体系的应用进程进行标识</strong>

- TCP / IP 体系的运输层使用<strong style="color:red">端口号</strong>来区分应用层不同应用进程

  - 端口号使用 16 比特标识，取值范围为：0~65535

    - 熟知端口：0~1023，INAN 把这些端口号指派给了 TCP / IP 体系中最重要的一些应用协议，例如：FTP 使用 21 / 20，HTTP 使用 80，DNS 使用 53
    - 登记端口号：1024~49151，为没有熟知端口号的应用程序使用，使用这类端口号必须在 IANA 按照规定的手续登记，以防止重复，例如：Microsoft RDP 微软远程桌面使用的端口号是 3389
    - 短暂端口号：49152~65535，留在客户进程选择暂时使用，当服务器进程收到客户进程的报文时，就知道了客户进程所使用的动态端口号。通信结束后，这个端口号可以供其他客户进程以后使用

    > :warning:**注意**：端口号只具有本地意义，即端口号只是为了标识计算机应用层中的各进程，在因特网中，不同计算机中的相同端口号是没有任何联系的
    
    > TCP / IP 体系模型中，主机使用 IP 标识，运行在主机上的进程使用 端口号 标识



**发送方的复用和接收方的分用**

![image-20230209145123600](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230209145123600.png)

> IP 数据报首部协议字段的值用来表明 IP 数据报的数据载荷部分封装的是何种协议数据单元



**TCP / IP 体系的应用层常用协议所使用的的运输层熟知端口号**

<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230209145755632.png" alt="image-20230209145755632" style="zoom:50%;" />



## 3.2 TCP 和 UDP 的对比

- UDP 可以随时传输数据，而 TCP 在进行传输数据之前，需要先通过 "三次握手" 来建立连接，传输完成之后，需要通过 "四次挥手" 断开连接

  ![image-20230209152529670](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230209152529670.png)

- UDP 支持一对一的单播、一对多的多播和一对全的广播，而 TCP 仅支持一对一传播

  ![image-20230209152948586](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230209152948586.png)

- UDP 是面向报文的，而 TCP 是面向字节流的（这正是 TCP 实现可靠传输的基础）

  ![image-20230209153649711](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230209153649711.png)

- UDP 向上层提供无连接、不可靠的传输服务，而 TCP 向上层提供面向连接、可靠的传输服务

  ![image-20230209154026985](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230209154026985.png)

- UDP 和 TCP 都是由首部和数据载荷两部分构成。由于 UDP 不提供可靠服务，首部非常简单，仅由 8 个字节构成；由于 TCP 要实现可靠传输、流量控制和拥塞控制等服务，所以首部复杂，最短 20 个字节，最长 60 个字节

  ![image-20230209154218330](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230209154218330.png)





:spiral_notepad:**总结**![image-20230209155346132](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230209155346132.png)





## 3.3 流量控制

流量控制（flow control）：<strong style="color:red">让发送方的发送速率不要太快，要让接收方来得及接收</strong>

> 利用<strong style="color:red">滑动窗口机制</strong>可以很方便地在 TCP 连接上实现对发送方的流量控制

接下来我们将举例说明问题：

假设 主机 A 和 B 是因特网上的两台主机，他们之间已经建立了 TCP 连接，A 给 B 发送数据，B 对 A 进行流量控制，主机 A 中待发送的字节序号为 1-900，假设传送的每个报文段大小为 100 字节数据，现在来模拟流量控制的过程

![image-20230209161641478](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230209161641478.png)

1. B "告诉" A："我的接收窗户为 400"，于是 主机 A 将自己的发送窗口也设置为 400

   > 这意味着主机 A 在未收到主机 B 发来的确认时，可将序号落入的窗口中的全部数据发送出去

2. 主机 A 将发送窗口序号 1 - 100 的数据封装成一个 TCP 报文段发送出去，窗口剩余可发送字节数为 300

   <img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230209162150687.png" alt="image-20230209162150687" style="zoom:50%;" />

   > `seq` 是 TCP 报文段首部中的<strong style="color:red">序号字段</strong>，取值 1 表示该报文段的数据载荷的第一个字节序号为 1

3. 主机将发送窗口内序号 101 - 200 的数据封装成一个 TCP 报文端发送出去，窗口剩余可发送字节数为 200

4. 主机发送 201 - 300 号字节数，但丢失了，窗口剩余可发送字节数为 100

   <img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230209165124185.png" alt="image-20230209165124185" style="zoom:50%;" />

5. 主机 B 对主机 A  201 号以前发送的数据进行累计确认，并在该累计确认中将窗口字段的值调整为 300，也就是对主机 A 进行流量控制。201-300 为已发送字节，若重传计时器超时，则会被重传；301 - 400 号字节以及 401 - 500 号字节还未被发送，可被分别封装在一个 TCP 报文段中发送，同时主机 A 可以将发送缓存中序号为 1-200 的字节数据全部删除

   <img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230209170133723.png" alt="image-20230209170133723" style="zoom:50%;" />

   > - ACK 是 TCP 报文段首部中的标志位，取值 1 表示这是一个 TCP 确认报文段
   > - ack 是 TCP 报文段首部中的确认号字段，取值 201 表示序号 201 之前的数据已全部接收，现在希望收到 201 后续数据
   > - rwnd 是 TCP 报文段首部中的窗口字段，取值 300 表示自己接收窗口大小为 300

6. 主机 B 发送 301 - 400 号字节数据，还能发送 100 字节

7. 主机 B 发送 401 - 500 号字节数据，不能再发送新数据

   <img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230209170917411.png" alt="image-20230209170917411" style="zoom:50%;" />

8. 发送窗口内序号为 201 - 300 这个100 个字节的重传计时器超时，主机 A 将其重新封装成一个 TCP 报文段发送出去，暂时不能发送其他数据

   ![image-20230209171054312](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230209171054312.png)

9. 主机 B 在收到重传的 TCP 报文后，对收到的 501 号以前的数据进行累计确认，并将接收窗口调整为 100，对主机 A 进行流控

10. 主机 A 在收到累计确认后，将发送窗口向前滑动，是已发送并收到确认的这些数据的序号移发送窗口，同时主机 A 会将自己的发送窗口序号调整为 501 - 600，之后删除 501 号之前的发送缓存 

11. 主机 A 发送 501 - 600 号字节数据后不能再发送新数据

12. 主机 B 第三次累计确认 + 流控，并将接收窗口调整为 0

![image-20230209171800287](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230209171800287.png)

13. 待主机 B 的接收缓存中又拥有了一些空间，于是主机 B 向 主机发送接收窗口为 300 的报文段，如果不幸报文丢失，可能会造成死锁，为了解决这一问题，<strong style="color:red">TCP 为每一个连接设有一个持续计时器，只要 TCP 连接的一方收到对方的零窗口通知就会启动</strong>

    ![image-20230209172016144](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230209172016144.png)

14. 持续计时器超时后，主机 A 会发送一个零窗口探测报文，仅携带 1 字节数据，而对方在确认这个探测报文后

    - 如果给出自己的接收窗口仍然为 0，则再次启动持续计时器
    - 如果不是 0，那么死锁的局面就可以被打破

    > :warning:注意：零窗口探测报文也有自己的重传计时器，防止丢失

![image-20230209173023377](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230209173023377.png)

**:thinking:既然接收窗口大小为 0，又如何能够接收 1 字节的零窗口探测报文呢？**

实际上，TCP 规定，即使接收窗口为 0，也必须接收零窗口探测报文段、确认报文段、以及携带了紧急数据的报文段



**习题**

![image-20230209180000005](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230209180000005.png)



## 3.4 拥塞控制

拥塞控制的概念：在某段时间，若<strong style="color:red">对网络中某一资源的需求超过了该资源所能提供的可用部分</strong>，网络性能就要变坏，这种情况就叫做拥塞（congestion）

> 在计算机网络中的链路容量（即带宽）、交换结点中的缓存和处理机等，都是网络的资源

若出现拥塞而不进行控制，整个网络的<strong style="color:red">吞吐量将随输入负荷的增大而下降</strong>

![image-20230209185342073](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230209185342073.png)

> - 输入负载：单位时间内输入给网络的分组数量
> - 吞吐量：单元时间内从网络输出的分组数量

我们应该使得拥塞控制尽可能接近理想的拥塞控制，因而提出了下述四种拥塞控制算法：

1. 慢开始（slow-start）
2. 拥塞避免（congestion avoidance）
3. 快重传（fast retransmit）
4. 快恢复（fast recovery）

在介绍这四种拥塞控制算法的基本原理，我们假定如下条件：

1. 数据是单方向的，而另一个方向只传送确认
2. 接收方总是有足够大的缓存空间，因而发送方发送窗口的大小是由网络的拥塞程度来决定的
3. 以最大报文段 MSS 的个数讨论问题的单位，而不是以字节为单位

![image-20230209211944096](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230209211944096.png)

- 发送方维护一个叫做<strong style="color:red">拥塞窗口 cwnd </strong>的状态变量，其值取决于<strong style="color:red">网络的拥塞程度</strong>，并且动态变化
  - 拥塞窗口 cwnd 的维护原则：只要网络没有拥塞，拥塞窗口就再增大一些；但只要网络出现拥塞，拥塞窗口就减少一些
  - 判断出现网络拥塞的依据：没有按时收到应当到达的确认报文（即发生超时重传）
- 发送方将<strong style="color:red">拥塞窗口作为发送窗口 swnd</strong>，即：<strong style="color:red">swnd = cwnd</strong>
- 维护一个慢开始门限 ssthresh 状态变量
  - 当 $cwnd < ssthresh$ 时，使用慢开始算法
  - 当 $cwnd > ssthresh$ 时，停止使用慢开始算法而改用拥塞避免算法
  - 当 $cwnd = ssthresh$ 时，既可以使用慢开始算法，也可以使拥塞避免算法





### 3.4.1 慢开始和拥塞避免算法

![image-20230209222932169](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230209222932169.png)

对上图我们详述其过程：

该图横坐标代表发送和接收完一个报文段来回的次数，纵坐标代表拥塞窗口 cwnd 的大小

> 使用传输轮次是为了强调把拥塞窗口所允许发送的报文段都连续发送出去，并收到了对已发送的最后一个报文段的确认

1. 在 TCP 双方建立逻辑连接关系时，拥塞窗口的值设置为 1，并在本例中假设慢开始门限的初始值为 16
2. 发送方开始发送 0 号数据报文段，接收方收到后，给发送方发回对 0 号报文段的确认报文段。
3. 发送方收到确认报文段后，将拥塞窗口由 1 增大到 2
4. 发送方开始发送 1-2 号两个报文段，接收方收到后，给发送方发回 1 - 2 号报文段的确认报文段
5. 发送方收到确认报文段后，将拥塞窗口由 2 增大到 4
6. 之后依次类推……，一直到拥塞窗口增大到慢开始门限 16 后，<strong style="color:red">由慢开始算法改为拥塞避免算法，即每次传输结束后，拥塞窗口值线性加1，而不像慢开始算法一样，每个传输轮次结束后，拥塞窗口值指数规律增长</strong>
7. 当使用拥塞避免算法，拥塞窗口的值增长到 24 后，开始产生拥塞，即无法收到接收方的发回的确认报文，需要进行以下工作：
   - 将 sshresh 更新为发生拥塞时拥塞窗口值的一半，即12
   - 将拥塞窗口值减少到 1， 并重新开始执行慢开始算法
8. 后续操作基本类似

:warning:**注意事项**

1. "慢开始" 是指一开始向网络中注入的报文段少，并不是指拥塞窗口 cwnd 增长速度慢
2. "拥塞避免" 并非指完全能够避免拥塞，而是指在拥塞避免阶段将拥塞窗口按线性规律增长，使网络比较不容易出现拥塞



**补充**

- 慢开始和拥塞避免算法时 1988 年提出的 TCP 拥塞控制算法（TCP Tahoe 版本）
- 1990 年又增加了两个新的拥塞控制算法（改进 TCP 的性能），这便是快重传和快恢复（TCP Reno）



### 3.4.2 快重传和快恢复算法

快重传和快恢复是为了解决慢启动和拥塞控制的以下不足而出现的以下情况

有时，个别报文段会在网络中丢失，但实际上网络并未发生拥塞，将会导致：

- 发送方超时重传，并误以为网络发生拥塞
- 发送方将拥塞窗口 cwnd 又设置为最小值 1，并错误地启动慢开始算法，因而降低了传输效率

采用快重传算法可以<strong style="color:red">让发送方尽早知道发生了个别报文段的丢失</strong>

所谓快重传，就是是发送方尽快进行重传，而不是等超时重传计时器超时时再重传

- 要求接收方不要等待自己发送数据时才进行捎带确认，而是要立即发送确认

- 即使收到了失序的报文段也要立即发出对已收到的报文段的重复确认

- **发送方一旦收到 3 个连续的重复确认，就将相应的报文段立即重传**，而不是等该报文段的超时重传计算器超时再重传

  ![image-20230210001019478](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230210001019478.png)

- 对于个别丢失的报文段，发送方不会出现超时重传，也就不会误认为出现了拥塞（从而降低了 cwnd 为 1 的次数）。使用快重传可以使整个网络的吞吐量提高约 20%

发送方一旦收到 3 个连续的重复确认，就知道现在只是丢失了个别的报文段。于是不启动慢开始算法，而是执行快恢复算法

- <strong style="color:red">发送方将慢开始门限 ssthresh 和拥塞窗口 cwnd 的值调整为当前窗口的一半，开始执行拥塞避免算法</strong>
- 也有的快恢复实现是把快恢复开始的拥塞窗口 cwnd 值再增大一些，即等于新的 ssthresh + 3
  - 既然发送方收到 3 个重复的确认，就表明有 3 个数据报文段已经离开了网络
  - 这 3 个报文段不再消耗网络资源而是停留在接收方的接收缓存中
  - 可见现在网络中不是堆积了报文段，而是减少了 3 个报文段，因此可以适当把拥塞窗口扩大些

**四种算法综合折线变化图**

![image-20230210002715370](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230210002715370.png)



**习题**

![image-20230210003055013](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230210003055013.png)



## 3.5 TCP 超时重传时间的选择

超时重传事件的选择是TCP 最为复杂的问题之一

- 如果超时重传时间小于报文发送时的往返时间 RTT，那么则会引起<strong style="color:red">不必要的报文重传，使网络负荷增大</strong>
- 如果超时重传时间大于报文发送时的往返时间 RTT，会使网络的空闲时间增大，降低了传输效率

<center>
    <img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230210105540624.png" style="float:left;width:48%">
    <img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230210105601597.png" style="float:right;width:48%">
</center>












所以，一个比较合理的选择方案是：<strong style="color:red">超时重传时间 RTO 应略大于往返时间 RTT</strong>

但是，RTT 并不是固定不变的，它会随经过的局域网频率高低、IP 数据报中的转发路由的不同等等而变化，这时超时重传时间的选择就不那么简单了 

- 不能直接使用某次测量得到的 RTT 样本来计算超时重传时间 RTO

- 利用每次测量得到的 RTT 样本，计算加权平均往返时间 RTTs（又称为平滑的往返时间）

  $RTT_S = (1 - \alpha) \times 旧的RTT_S+ \alpha \times 新的 RTT 样本$

  $RTT_{S1}=RTT_1$

  在上式中，$0 \leq \alpha 1 < 1$

  - 在 $\alpha$ 很接近于 0，则新的 $RTT$ 样本对 $RTT_S$ 的影响不大
  - 若 $\alpha$ 很接近与 1，则新的 $RTT$ 样本对 $RTT_S$ 影响较大
  - 已成为建议标准的 RFC6298 推荐的 $\alpha$ 值为 $\frac{1}{8}$，即 0.125

<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230210112356787.png" alt="image-20230210112356787" style="zoom:50%;" />

但是，实际上 RTT 样本的采集也并不是那么容易的，以下图为例：

![image-20230210112729539](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230210112729539.png)

针对<strong style="color:red">出现超时重传时无法测准往返时间 RTT</strong>的问题，Karn 提出了一个算法：在计算加权平均往返时间 $RTT_S$ 时，只要报文段重传，就不采用其往返时间 RTT 样本。也就是出现重传时，不重新计算 $RTT_S$，进而超时重传时间 RTO 也不会重新计算。

- 但是这又会引起新的问题，如果报文段的时延增大了很多，并且很长一段时间内都保持这种状态。因而在原来得出的重传时间内，不会收到确认报文段，于是重传报文，但是根据 Karn 算法，不考虑重传报文段的往返时间样本，超时重传时间无法更新，这会导致报文段被反复重传

因此，要对 Karn 算法进行修正，方法是：<strong style="color:red">报文段每重传一次，就把超时重传时间 RTO 增大一些</strong>，典型的做法是将新的 RTO 的值取为旧 RTO 值的 2 倍

**习题**

![image-20230210124755329](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230210124755329.png)



## 3.6 TCP 可靠传输的实现

TCP 通过基于<strong style="color:red">以字节为单位的滑动窗口</strong>来实现可靠传输

![image-20230210130641814](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230210130641814.png)

> TCP 不建议前沿向后收缩，因为可能在发送方收到接收窗口缩小之前这个通知之前，就已经发送了窗口中的许多数据



**如何描述发送窗口的状态？**

![image-20230210142342488](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230210142342488.png)

使用三个指针 P1、P2、P3 分别指向相应的字节序号

- 小于 P1 的是已收到并确认的字节序号
- 大于等于 P3 的是不允许发送的部分
- P3 - P1 = 发送窗口的尺寸
- P2 - P1 = 已发送但尚未收到确认的字节数
- P3 - P2 = 允许发送但当前未发送的字节数（又称为可用窗口或有效窗口）

:spiral_notepad:**总结**

- 虽然发送方的发送窗口是根据接收方的接收窗口来设置的，但是在同一时刻，<strong style="color:red">发送方的发送窗口并不总是和接收方的接收窗口</strong>一样大

  - 网络传送窗口值需要经历一定时间滞后，并且这个时间还是不确定的
  - 发送方还可能根据网络当时的拥塞情况适当减小自己的发送窗口尺寸

- <strong style="color:red">对于不按序到达的数据应该如何处理，TCP 并无明确规定</strong>

  - 如果接收方把不按序到达的数据一律丢弃，那么接收窗口的管理将会比较简单，但这样对网络资源的利用不利，因为发送方会重复传送较多的数据
  - TCP通常对不按序到达的数据先是临时存放在接收窗口中，等到字节流中所缺少的字节收到后，再按序交付上层的应用进程

- TCP 要求接收方必须有<strong style="color:red">累计确认和捎带确认机制</strong>，这样可以减小传输开销。接收方可以在合适的时候发送确认，也可以在自己有数据要发送时把确认信息顺便捎带上

  - <strong style="color:red">接收方不应过分推迟发送确认</strong>，否则会导致发送方不必要的超时重传，这反而浪费了网络的资源

    > TCP 标准规定，确认推迟的时间不应该超过 0.5 s。若收到一连串具有最大长度的报文段，则必须每隔一个报文段就发送一个确认【RFC 1122】

  - 捎带确认实际上不经常发生，因为大多数应用程序很少同时在两个方向上发送数据

- TCP 是<strong style="color:red">全双工通信</strong>。通信中的每一方都在发送和接收报文段。因此，每一方都有自己的发送窗口和接收窗口。

**习题**

![image-20230210152243776](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230210152243776.png)



![image-20230210152527212](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230210152527212.png)



## 3.7 TCP 的运输连接管理

- TCP 是面向连接的协议，它基于运输连接来传送 TCP 报文段

- TCP 运输连接的建立和释放是每一次面向连接的通信中必不可少的过程

- TCP 运输连接有以下三个阶段

  1. 建立 TCP 连接
  2. 数据传输
  3. 释放 TCP 连接

  <img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230210153319048.png" alt="image-20230210153319048" style="zoom:25%;" />

- TCP 的运输连接管理就是使运输连接的建立和释放都能正常地运行



### 3.7.1 TCP 的连接建立

TCP 连接建立要解决以下三个问题：

1. 使 TCP 双方能够确知对方的存在
2. 使 TCP 双方能够协商一些参数（如最大窗口值、是否使用窗口扩大选项和时间戳选项以及服务质量）
3. 使 TCP 双方能够对运输实体资源（如缓存大小、连接表中的项目等）进行分配

![image-20230210154323974](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230210154323974.png)

> - 同步位 `SYN` 被设置为 1 的报文段不能携带数据，但需要消耗一个序号
> - TCP 规定：普通报文段可以不携带数据，如果不携带数据，则不消耗序号

:thought_balloon: **思考：发送针对 TCP 连接请求的确认的确认是否多余？**

答：并不多余，我们并不能将其简化为 "两报文握手"。理由如下：

![image-20230210160014355](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230210160014355.png)

TCP 客户进程发出一个TCP 连接请求报文段，但该报文段在某些网络结点长时间滞留，这必然会造成该报文段的超时重传。假设重传的报文段被服务器进程正常接收，TCP 服务器进程给 TCP 客户进程发送一个 TCP 连接请求确认报文段，并直接进入**连接已建立状态**（这里模拟 "两报文握手"），而不像 "三报文握手" 那样进行 **同步已接收状态**，之后双方进行数据传输，最后释放连接进入关闭状态。一段时间后，滞留的 TCP 连接请求到达了 TCP 服务器进程，TCP 服务器进程会误以为这是 TCP 客户进程，又发起一个新的 TCP 连接请求，之后直接进入已连接状态，服务器进程会一直等待客户端进程发来数据，但客户端此时处于关闭状态，就会极大地浪费了服务器的资源

总结：使用 "三报文握手"，而不使用 "两次握手" 的原因就是<strong style="color:red">为了防止已失效的报文段突然又传送到 TCP 服务器因而导致错误</strong>



**习题**

![image-20230210161440036](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230210161440036.png)



### 3.7.2 TCP 连接释放

TCP 通过 "四报文挥手" 来释放连接，传输结束后，TCP 双方都可以都可以主动关闭连接

![image-20230210171239911](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230210171239911.png)

> 对于现在而言，最长报文段寿命设置为 2 分钟可能太长了，TCP 可以根据具体情况使用更小的 MSL 值

现在假设使用 TCP 客户进程的应用进程通知其主动关闭 TCP 连接：

1. TCP 客户进程会发送 TCP 连接释放报文段，并进入终止等待1状态

   > - 释放报文的终止位 FIN 和确认位 ACK 都被设置为 1，表明这是一个 TCP 连接释放报文段，同时也对之前收到的报文段进行确认
   > - 序号字段 seq 的值设置为 u = TCP 客户进程之前已传送过的数据的最后一个字节序号 + 1
   > - TCP 规定终止位 FIN 等于 1 的报文段即使不携带数据，也要消耗一个序号
   > - 确认号 ack 值为 v，等于 TCP 客户进程之前已收到的数据的最后一个字节的序号 + 1

2. TCP 服务器进程收到 TCP 连接释放报文段后，会发送一个**普通的 TCP 确认报文段**并进入关闭等待状态

   > - ACK 的值设置为 1，表明这是一个普通的 TCP 确认报文段
   > - 序号 seq 字段的值设置为 v，等于 TCP 服务器进程之前已传送过的数据的最后一个字节序号 + 1（与之前 TCP 连接释放报文段中的确认号匹配）
   > - 确认号 ack 字段的值设置为 u+1，这是对 TCP 连接释放报文段的确认

3. 此时 TCP 服务器进程会通知高层应用进程：TCP 客户进程要断开与自己的 TCP 连接，此时**从 TCP 客户进程到 TCP 服务器进程的这个方向的连接就释放了**，这时 TCP 连接属于**半关闭状态**

4. 假设此时 TCP 服务器进程还有数据要发送，TCP 客户进程仍要接收（因为此时从 TCP 服务器进程到 TCP 客户进程这个方向的连接还并未断开）

5. TCP 客户进程在收到 TCP 服务器端的确认报文后就进入**终止等待 2 状态**，等待 TCP 服务器进程发出的 TCP 连接释放报文段

6. 若使用 TCP 服务器进程的应用进程已经没有数据要发送了，应用进程就通知  TCP 服务器进程释放连接，于是 **TCP 服务器进程发送 TCP 连接释放报文段并进入最后确认状态**

   > - 该报文段首部中的终止位 FIN 和确认位 ACK 都被设置为 1， 表明这是一个 TCP 连接释放报文段
   > -  seq 的字段的值为 w ，这是因为在半关闭状态下，存在服务器发送给客户端的数据，如果期间没有数据传送，那么 w 的值就是 v
   > - ack 的值仍然为 u+1，这是对之前收到的 TCP 连接释放报文段的重复确认

7. TCP 客户端必须针对服务端发送的连接释放报文发送普通的 TCP 确认报文段，之后进入时间等待状态



**:thought_balloon:思考：客户端进程在发送完最后一个报文段后，为什么不直接进入关闭状态，而是要进入时间等待状态 2MSL 后才进入关闭状态，这是否是有必要的呢？**

![image-20230210192142907](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230210192142907.png)

我们现在想一下这种情况，服务器进程发送 TCP 连接释放报文到客户端进程，客户端接收到后会针对该释放报文发送一个普通的 TCP 确认报文段；

现在恰好该确认报文段丢失，那么服务器端势必会进行超时重传，但由于客户端没有进行等待，而是直接进入的关闭状态，不会对 TCP 服务器发送的重传报文做出响应，从而 服务器 -> 客户端的这段连接始终无法进入 CLOSED 状态

总结：客户端的时间等待状态是有必要的，处于该状态的 2MSL 的时长可以<strong style="color:red">确保 TCP 服务器进程可以收到最后一个 TCP 确认报文段而进入关闭状态，另外 TCP 客户进程在发送完最后一个 TCP 确认报文段后，再进过 2MSL 时长，就可以使本次连接持续时间内所产生的所有报文段都从网络中消失，使得新 TCP 连接中不会出现旧连接中的报文段</strong>



:herb:**扩展：TCP 中保活计时器的作用**

如果 TCP 客户进程和 TCP 服务进程之间已经建立好了连接，但是此时 TCP 客户端主机出现故障，显然TCP 服务器不能一直等待客户端发送请求，问 TCP 服务器如何发现这一情况？

![image-20230210194452043](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230210194452043.png)

- TCP 服务器进程没收到一次 TCP 客户进程的数据，就重新设置并启动<strong style="color:red">保活计时器</strong>（2 小时定时）
- 若保活计时器定时周期内收到 TCP 客户进程发来的数据，则当保活计时器到时候，TCP 服务器进程就向 TCP 客户进程发送一个探测报文段，以后每隔 75s 发送一次。若一连发送 10 个探测报文后仍无 TCP 客户进程的响应，TCP 服务器进程就认为 TCP 客户进程所在主机处理故障，接着就会关闭这个连接



## 3.8 TCP 报文的首部格式

- 为了实现可靠传输，TCP 采用来<strong style="color:red">面向字节流</strong>的方式
- 但 TCP 在发送数据时，是从发送缓存中取出一部分或全部字节并给其并给其添加一个首部使之成为 TCP 报文段后进行发送
  - 一个 TCP 报文段由<strong style="color:red">首部</strong>和<strong style="color:red">数据载荷</strong>两部分构成
  - TCP 的全部功能都体现在它首部中各字段的作用



![image-20230210202405393](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230210202405393.png)

- 源端口：占 16  比特，写入源端口号，用来<strong style="color:red">标识发送该 TCP 报文段的应用进程</strong>

- 目的端口：占 16 比特，写入目的端口号，用来<strong style="color:red">标识接收该 TCP 报文段的应用进程</strong>

- 序号（seq）：占 32 比特，取值范围为 $[0, 2^{32}-1]$，序号增加到最后一个后，下一个序号就又回到 0，<strong style="color:red">指出本 TCP 报文数据载荷的第一个字节的序号</strong>

- 确认号（ACK）：占 32 比特，取值范围为 $[0, 2^{32}-1]$，确认好增加到最后一个后，下一个确认号就又回到 0。该字段用于指出<strong style="color:red">期望收到对方下一个 TCP 报文段的数据载荷的第一个字节的序号，同时也是对之前收到所有数据的确认</strong>

  > <strong style="color:orange">若确认号 = n，则表明到序号 n-1 为止的所有数据都已正确接收，期望接收序号为 n 的数据</strong>

- 确认标志位ACK：<strong style="color:red">取值为 1 时确认号字段才有效</strong>；取值为 0 时确认号字段无效

  > TCP 规定：<strong style="color:orange">在连接建立后所有传送的 TCP 报文段都必须把 CK 置为1</strong>

- 数据偏移：占 4 比特，<strong style="color:red">并以 4 字节为单位</strong>。<strong style="color:red">用来指出 TCP 报文段的数据载荷部分的起始处距离 TCP 报文段的起始处有多远</strong>。这个字段实际上是指出了 TCP 报文段首部长度

  - 首部固定长度的为 20 字节，因此数据偏移字段的最小值为 $(0101)_2$
  - 首部最大长度为 60 字节，因此数据偏移字段的最大值为 $(1111)_2$

- 保留：占 6 比特，保留为今后使用，但目前应置为 0
- 窗口：占 16 比特，占 16 比特，以字节为单位。指出发送本报文段的一方的接收窗口
  - 窗口值作为接收方让发送方设置其为发送窗口的依据
  - 这是以接收方的接受能力来控制发送方的发送能力，称为流量控制

- 校验和：占 16 比特，检查范围包括 TCP 报文段的首部和数据载荷两部分，在计算机检验和时，要在 TCP 报文段的前面加上 12 字节的伪首部

- 同步标志位 SYN：用来建立 TCP 连接

- 终止标志位 FIN：用来释放 TCP 连接

- 复位标志位 RST：用来复位 TCP 连接，当RST = 1 时，表明 TCP  连接出现了异常，必须释放连接，然后再重新建立连接；RST 置 1 还用来拒绝一个非法的报文段或拒绝打开一个 TCP 连接

- 推送标志位 PSH：接收方的 TCP 收到该标志位为 1 的报文段会<strong style="color:red">尽快上交应用进程</strong>，而不必等到接收缓存都填满后再向上交付

- 紧急标志位 URG：取值为 1 时紧急指针字段有效；取值为 0 时紧急指针字段无效

- 紧急指针：占 16 比特，以字节为单位，用来指明紧急数据的长度

  > 当发送方有紧急数据，可将紧急数据插队到发送缓存的最前面，并立刻封装到一个 TCP 报文段中进行发送。紧急指针会指出本报文段数据载荷部分包含了多张的紧急数据，紧急数据之后便是普通数据

- TCP 报文段还有 40 字节的选项，用来扩充功能，主要有以下选项：

  - 最大报文长度 MSS 选项：TCP 报文段数据载荷部分的最大长度
  - 窗口扩大选项：为了扩大窗口（提高吞吐率）
  - 时间戳选项
    - 用来计算往返时间 RTT
    - 用于处理序号超范围的情况，又称为防止序号绕回 PAWS
  - 选择确认选项：用来实现选择确认功能

- 填充：由于选项的长度可变，因此使用填充来<strong style="color:red">确保报文段首部能够被 4 整除</strong>（因为数据偏移字段，也就是首部长度字段，是以 4 字节为单位的）



# 4 网络层

网络层的主要任务是<strong style="color:red">实现网络互连</strong>，进而<strong style="color:red">实现数据包在各网络之间的传输</strong>

要实现网络层任务，需要解决以下主要问题：

- 网络层向运输层提供怎样的服务（"可靠传输" 还是 "不可靠传输"）

  > - 因特网是基于 TCP / IP 体系的网际层，提供的是无连接、不可靠的数据报服务；
  >
  > -  而 ATM、帧中继和 X.25 的网络层提供的都是面向连接的、可靠的虚电路服务

- 网络层寻址问题

- 路由选择问题



因特网（Internet）是目前全世界用户数量最多的互联网，它使用 <strong style="color:red">四层体系的TCP / IP 协议栈</strong>

- 由于 TCP / IP 协议栈的网络层使用<strong style='color:red'>网际协议 IP</strong>，它是整个协议栈的核心协议，因此在 TCP / IP 协议栈中网络层常被称为<strong style="color:red">网际层</strong>



![image-20230210225012642](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230210225012642.png)





## 4.1 网络层提供的两种服务

网络层向上提供两种服务：<strong style="color:red">面向连接的虚电路和无连接的数据包服务</strong>

### 4.1.1 面向连接的虚电路服务

![image-20230210225837020](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230210225837020.png)

- 虚电路服务强调<strong style="color:red">可靠通信由网络保证</strong>
- 必须建立<strong style="color:red">网络层的连接</strong> —— <strong style="color:red">虚电路 VC（Virtual Circuit）</strong>
- 通信双方<strong style="color:red">沿着已建立的虚电路发送分组</strong>
- 目的主机的地址仅在连接建立阶段使用，之后<strong style="color:red">每个分组的首部都只需携带一条虚电路的编号</strong>（构成虚电路的每一段链路都有一个虚电路编号）
- 这种通信方式如果再使用可靠传输的网络协议，就可使所发送的分组最终正确到达接收方（无差错按需到达、不丢失、不重复）
- <strong style="color:red">通信结束后，需要释放之前所建立的虚电路</strong>
- 很多广域分组交换网都使用面向连接的虚电路服务。例如：曾经的 X.25 和逐渐过时的帧中继 FR、异步传输模式 ATM 等

### 4.1.2 无连接的数据报服务

数据报服务的核心思想：

- 可靠通信应该有<strong style="color:red">用户主机</strong>来保证
- <strong style="color:red">不需要建立网络层连接</strong>
- <strong style="color:red">每个分组可走不通的路径</strong>
- 这种分组的<strong style="color:red">首部必须携带目的主机的完整地址</strong>
- 这种通信方式所传送的分组可能误码、丢失、重复和失序
- 由于<strong style="color:red">网络本身不提供端到端的可靠传输服务，这就使得网络中路由器可以做得比较简单</strong>，而且价格低廉
- 因特网采取这种思想，将复杂的网络处理功能置于因特网边缘的（用户主机和内部的运输层），而将相对简单的尽最大努力的分组交付功能置于因特网核心

**总结如下**

![image-20230210234349487](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230210234349487.png)





## 4.2 IPv4 地址及其应用

### 4.2.1 IPv4 地址概述

IPv4 地址就是因特网上的<strong style="color:red">每一台主机（或路由器）的每一个接口</strong>分配一个在全世界范围内是<strong style="color:red">唯一的 32 比特的标识符</strong>

IP 地址由因特网名字和数字分配机构 ICANN（**I**nternet **C**orporation for **A**ssigned **N**ames and **N**umbers） 进行分配

- 我国用户可向 APINC 申请 IP 地址，需要缴费

- 2011年2月3日，IPv4 地址已经分配完毕

- 我国在 2014 至 2015 年也逐步停止向新用户分配 IPv4，开始全面开展商用部署 IPV6

- IPv4 地址的编址方法经历了以下三个历史阶段;

  ![image-20230211000305044](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211000305044.png)



IPv4 地址采用<strong style="color:red">点分十进制</strong>表示方法以方便用户使用

举例如下：

![image-20230211000436579](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211000436579.png)

![image-20230211000932276](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211000932276.png)



### 4.2.2 分类编址的 IPv4 地址

![image-20230211002419945](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211002419945.png)



#### 01 A 类地址

![image-20230211102354466](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211102354466.png)

- 最小网络号 0，保留不指派
  - 第一个可指派的网络号为 1，网络地址为 1.0.0.0
- 最大网络号 127，作为本地环回地址，不指派
  - 最小的本地环回测试地址为 127.0.0.1
  - 最大的本地环回测试地址为 127.255.255.254
- 最后一个可指派的网络号为 126，网络地址为 126.0.0.0
- 可指派的网络数量为 126 个
- A 类网络中每个网络可分配的 IP 地址数量为 $2^{24}-2$（去掉主机号 "全0" 的网络地址和 "全1" 的广播地址）



#### 02 B 类地址

![image-20230211112210239](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211112210239.png)



#### 03  C 类地址

![image-20230211112935948](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211112935948.png)



#### 习题

![image-20230211113724130](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211113724130.png)



![image-20230211114338504](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211114338504.png)



![image-20230211122836277](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211122836277.png)



### 4.2.3 划分子网的 IPv4 地址

划分子网的目的就是为了节省网络地址的使用。

假设某单位中有一个大型的局域网需要连接到因特网，如果申请了一个 B 类网络，但是由于 B 类网络可分配的IP 地址有 65534 个，在给该单位每台主机分配完毕之后，还有大量剩余可分配的 IP 地址，后来随着该单位计网的发展和建设，该单位又新增一些计算，并且需要将原来的网络划分了三个独立的网络，如果我们还去单独为这些网络申请网络地址，会产生如下弊端：

- 需要等待时间和花费更多的费用
- 会增加其他路由器中路由表记录的数量
- 浪费原有网络中剩余的大量 IP 地址

所以，我们可以考虑通过**划分子网**的方式，从 IP 地址的主机号部分借用一些作为子网号来区分不同子网，就可以最大程度地利用原有网络中剩余的大量 IP 地址。

为了从主机号区分子网号，我们引入**子网掩码**

- <strong style="color:red">32 比特的子网掩码可以表明分类 IP 地址的主机号部分被借用了多少个比特作为子网号</strong>
- 子网掩码使用<strong style="color:red">连续的比特 1 来对应网络号和子网号</strong>
- 子网掩码使用<strong style="color:red">连续的比特 0 来对应主机号</strong>
- 将划分子网的<strong style="color:red"> IPv4 地址与其相应的子网掩码进行逻辑与运算就可以得到 IPv4 地址所在子网的网络地址</strong>

![image-20230211134618782](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211134618782.png)



**例如**

![image-20230211135415646](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211135415646.png)



**习题**

![image-20230211135439731](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211135439731.png)

![image-20230211140024655](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211140024655.png)



**默认子网掩码**

<strong style="color:red">默认的子网掩码是指在未划分子网的情况下使用的子网掩码</strong>

![image-20230211140653600](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211140653600.png)



### 4.2.4 无分类编址的 IPv4 地址

**引入**

- 划分子网在一定程度上缓解了因特网在发展中遇到的困难，<strong style="color:red">但数量巨大的 C 类因为其地址空间太小并没有得到充分使用</strong>，而因特网的 IP 地址正在加速消耗，整个 IPv4 地址空间面临全部耗尽的威胁
- 为此，因特网工程任务组 IETF 又提出采用<strong style="color:red">无分类编址</strong>的方法来解决 IP 地址紧张的问题，同时还专门成立 IPv6 工作组负责研究新版本 IP 以彻底解决 IP 地址耗尽的问题
- 1993 年，IETF 发布了无分类域间路由选择 CIDR（**C**lassless **I**nter-**D**omain **R**outing）文档
  - CIDR 消除了传统的 A 类、B 类和 C 类地址、以及划分子网的概念
  - CIDR 可以更加有效地分配 IPv4 的地址空间，并且可以在新的 IPv6 使用之前允许因特网的规模继续增长



**无分类编址的 IPv4 地址**

CIDR 使用 "<strong style="color:red">斜线记法</strong>"，或称 CIDR 法。即在 IPv4 地址后面加上斜线 "/"，<strong style="color:red">在斜线后面写上网络前缀所占的比特数量</strong>

例如：

![image-20230211144518290](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211144518290.png)

CIDR 实际上是<strong style='color:red'>网络前缀都相同的连续的 IP 地址组成一个 "CIDR 地址块"</strong>

我们一旦知道 CIDR 地址块中任何一个地址，就可以知道该地址块的全部细节：

- 地址块的最小地址
- 地址块的最大地址
- 地址块中的地址数量
- 地址块聚合某类网络（A 类、B 类或 C 类）的数量
- 地址掩码（也可以继续称为子网掩码）

**示例**

![image-20230211143931928](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211143931928.png)



**路由聚合**（构造超网）

![image-20230211150603277](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211150603277.png)

- <strong style="color:red">网络前缀越长，地址块越小，路由越具体</strong>
- 若路由器查表转发分组时发现有多条路由可选，则选择网络前缀最长的那条，这称为<strong style="color:red">最长前缀匹配</strong>

**习题**

![image-20230211151219802](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211151219802.png)

![image-20230211151816178](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211151816178.png)



### 4.2.5 IPv4 地址的应用规划

- 定长的子网掩码 FLSM（Fixed Length Subnet Mask）
  - 使用同一个子网掩码来划分子网
  - 子网划分不灵活：只能划分出 $2^n$ 个子网（n 是从主机号部分借用的用来作为子网号的比特数量）
  - 每个子网所分配的 IP 地址数量相同，造成 IP 地址的浪费
- 变长的子网掩码 VLSM （Variable Length Subnet Mask）
  - 使用不同的子网掩码来划分子网
  - 子网划分方式灵活：可以按需分配
  - 每个子网所分配的 IP 地址数量可以不同，尽可能减少对 IP 地址的浪费



![image-20230211154347674](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211154347674.png)

![image-20230211154522801](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211154522801.png)

![image-20230211154639604](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211154639604.png)



**而如果采用变长子网掩码，分配如下：**

![image-20230211154927696](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211154927696.png)

![image-20230211155753942](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211155753942.png)

> :warning:**注意：在给上图所示的网络 N1 ~ N5 分配子块，分配原则是：每个子块的起点位置不能随意选取，只能选择块大小整数倍的地址作为起点，建议先给大的子块分配**

**习题**

![image-20230211160123781](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211160123781.png)

## 4.3 IP 数据报的发送和转发过程

IP 数据报的发送和转发过程包含以下两部分：

- 主机发送 IP 数据报
- 路由器转发 IP 数据报

> 为了将重点放在 TCP / IP 协议栈的网际层发送和转发 IP 数据报的过程上，在之后的举例中，我们<strong style="color:red">忽略使用 ARP 协议来获取目的主机或路由器接口的 MAC 地址的过程以及以太网交换机自学习和转发帧的过程</strong>

**举例**

路由器的接口 0 和接口 1 都直连了一个交换式以太网

![image-20230211163845062](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211163845062.png)



![image-20230211163607987](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211163607987.png)

> - 同一子网中，主机之间 IP 数据报的交付称为直接交付
> - 不同子网中，主机之间 IP 数据报的交付称为间接交付

**源主机如何知道目的主机是否与自己在同一网络中？**

通过将自己的 IP 地址与子网掩码相与得到的网络地址与目的 IP 地址与自己的子网掩码相与得到的网络地址进行比对即可

![image-20230211165614587](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211165614587.png)

现在，主机 C 得知与主机 F 在不同的网络，需要将 IP 数据报交付路由器，那么，**主机 C 如何知道路由器 R 的存在？**

实际上，用户为了让本网络中主机能与其他网络中的主机进行通信，就必须给其指定本网络中的一个路由器，由该路由器帮忙转发，所指定的路由器被称为默认网关

![image-20230211170237944](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211170237944.png)

接下来，**路由器收到 IP 数据报后是如何进行转发的呢？**

1. 首先，路由器会检查 IP 数据报首部是否出错；
   - 若出错，则直接丢弃该 IP 数据报并通告源主机
   - 若没有出错，则进行转发
2. 根据 IP 数据报的目的地址在路由表中查找匹配的条目
   - 若找到匹配的条目，则转发给条目中指示的下一跳
   - 若没有找到，则丢弃该 IP 数据报并通告源主机

目的地址会与路由器中的路由表上的地址掩码进行相与，以得到目的网络地址

![image-20230211173534677](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211173534677.png)

最后，还需要说明的是：<strong style='color:red'>路由器是隔离广播域的</strong>

![image-20230211173848478](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211173848478.png)



**习题**

![image-20230211174559563](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211174559563.png)



![image-20230211174748455](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211174748455.png)

> "网际层" 是 "尽最大努力完整地传输数据报"，差错检验即 checksum 字段只能判断收到的 IP 分组是否正确，不能确保 IP 分组不丢失



![image-20230211175731300](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211175731300.png)



## 4.4 静态路由配置及其可能产生的路由环路问题

- 静态路由配置是指用户或网络管理员使用路由器的相关命令给路由器<strong style="color:red">人工配置路由表</strong>
  - 这种人工配置方式简单、开销小，但<strong style="color:red">不能及时适应网络状态（流量、拓扑等）的变化</strong>
  - 一般只能在小规模的网络中采用
- 使用静态路由配置可能出现以下导致产生<strong style="color:red">路由环路</strong>的错误
  - 配置错误
  - 聚合了不存在的网络
  - 网络故障

### 4.4.1 静态路由配置

![image-20230211193748225](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211193748225.png)



对于<strong style="color:red">具有相同下一跳的不同目的网络的路由条目</strong>，我们可以用一条默认路由条目来替代

![image-20230211194750747](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211194750747.png)



**特定主机路由示例**

有时候，我们可以给路由器添加针对某个主机的特定主机路由条目，一般用于网络管理人员对网络的管理和测试，有时在需要考虑某种安全问题时也可以采用特定主机路由

![image-20230211200417876](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211200417876.png)



### 4.4.2 静态路由配置错误导致路由环路

![image-20230211200759240](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211200759240.png)

如上图，如果 R2 要发送 IP 数据报到 192.168.1.0/24，会在路由表中进行**查表转发**，但由于配置错误，本该下一跳转发 R1 的接口 1，却错误地转发到 R3 的接口 0，即 10.0.1.2 ，R3 收到该数据报会进行查表转发，又转发到了 R2 的接口 1，如此循环往复。所以为了防止 IP 数据产生**环路**，IP 数据报首部添加了 TTL 字段，用来控制数据报的生存周期。



**聚合了不存在的网络而导致的路由环路问题**

![image-20230211202807663](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211202807663.png)

- 192.168.0.0 是一个聚合路由，该路由中聚合 C 类网有 4 个，其中只有 192.168.1.0/24 和 192.168.2.0/24 存在，其余两个不存在
- 当 R2 要转发路由到聚合路由中不存在的网络地址，例如 192.168.3.0，那么根据转发表还将 IP 数据报发送到  R1 的接口 1，之后通过默认路由又回到 R2，于是形成环路
- 要解决这一问题，可以在 R2 路由表中设置**黑洞路由**，让其下一跳为虚拟接口  null



**网络故障而导致路由环路**

![image-20230211211208973](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211211208973.png)

假设路由 R1 检测到其接口 0 所直连的网络出现故障而不可达，会自动在其路由表中删除该直连网络的路由条目，之后 R2 要转发 IP 数据报到该网络，进行查表转发，转发到 R1 后，R1 会走默认路由，就又和上例类似出现环路

解决方案：设置黑洞路由，让所有目的网络为故障网络的下一跳指向 null，而如果后续故障消失，则 R1 又自动地得出其接口 0 的直接网络的路由条目，黑洞路由设置为失效状态

![image-20230211211652947](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211211652947.png)



## 4.5 路由选择协议

### 4.5.1 路由选择协议概述

![image-20230211212020867](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211212020867.png)

因特网所采用的路由选择协议的主要特点：

- 自适应：动态路由选择，能较好地适应网络状态的变化
- 分布式：路由器之间交换路由信息
- 分层次：将整个因特网划分为许多较小的自治系统 AS（Autonomous System）

![image-20230211215203678](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211215203678.png)

- 域内路由选择使用内部网关协议 IGP
- 域间路由选择使用外部网关协议 EGP

![image-20230211215732313](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211215732313.png)

> 网关即"路由器"



**常见的路由选择协议**

![image-20230211215915603](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211215915603.png)



**路由器的结构**

![image-20230211221327744](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211221327744.png)

路由器分为两部分：<strong style="color:red">路由选择部分和分组转发部分</strong>

功能拆解：信号从某个输入端口进入路由器 -> 物理层将信号转换成比特流 -> 数据链路层从比特流中识别出帧 ，去掉帧头和帧尾，送交网络层处理 ->

- 如果送交网络层的分组是**普通待转发的数据分组** -> 根据分组转发中的目的地址进行查表转发 -> 若在转发表中找到，则按匹配条目中所指示的端口进行转发到输出端口 -> 网络层更新数据分组首部中的某些字段的值（例如 TSL - 1 ）-> 送交数据链路层进行封装成帧 -> 送交到物理层处理
- 如果送交网络层的分组是路由器之间**交换路由信息的路由报文** -> 则把分组送交路由选择处理机 -> 路由选择处理机根据分组内容更新自己的路由表

![image-20230211224431787](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211224431787.png)

> 路由选择处理机除了处理收到的路由报文外，还会周期性地给其他路由器发送自己所知道的路由信息

**路由还应具有输入缓冲区和输出缓冲区**

- 输入缓冲区用来处理**新进入路由器但还来不及处理**的分组
- 输出缓冲区用来暂存**已经处理完毕但还来不及发送**的分组



### 4.5.2 路由信息协议 RIP

- 路由信息协议 RIP（Routing Information Protocol）是内部网关协议 IGP 中最先得到广泛使用的协议之一，其相关标准文档为 RFC 1058
- RIP 要求自治系统 AS 内的每一个路由器都要维护从它自己到 AS 内其他每一个网络的距离记录。这是一组距离，称为 "距离向量 D -V（Distance-Vector）"

- <strong style="color:red">RIP 使用跳数（Hop Count）作为度量（Metric）来衡量到达目的网络的距离</strong>

  - 路由器到直连网络的距离定义为 1
  - 路由器到非直连网络的距离定义为所经过的路由器数 + 1
  - 允许一条路径中最多只能包含 15 个路由器。<strong style="color:red">"距离" 等于 16   时相当于不可达</strong>。因此，RIP 只适用于小型互联网

  ![image-20230211230121251](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211230121251.png)



**RIP 路由信息协议的基本工作原理**

- RIP 认为好的路由就是 "距离短" 的路由，也就是<strong style="color:red">所通过路由器数量最少的路由</strong>

- 当到达同一目的网络由多条 "距离相等" 的路由时，可以进行<strong style="color:red">等价负载均衡</strong>

  <img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211230507030.png" alt="image-20230211230507030" style="zoom:25%;" />

  >尽管这条链路带宽小，但是 RIP 仍会选择 R1 -> R4 -> R5

- RIP 包含以下三个要点

  - 和谁交换信息：仅和相邻路由器交换信息
  - 交换什么信息：自己的路由表
  - 何时交换信息：周期性交换

  <img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211231830834.png" alt="image-20230211231830834" style="zoom:33%;" />



![image-20230211232031786](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211232031786.png)



![image-20230211232537325](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211232537325.png)

**习题**

![image-20230211234058696](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211234058696.png)



RIP 存在 "<strong style="color:red">坏消息传播得慢</strong>" 的问题

![image-20230211234843124](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230211234843124.png)

- R1 通向 N1 的链路故障，R1 想等 RIP 更新周期到了之后，将路由表转发到 R2
- 但 RIP 更新周期一到，R2 也要转发路由表，并且速度比 R1 快，那么此时 R1 就会受到误导，认为 N1 到 R2 是可达的，跳数为 3
- 之后就会出现路由环路，时间长达数分钟，等跳数到达 16 后才知道不可达

"坏消息传播得慢" 又称为<strong style="color:red">路由环路</strong>或<strong style="color:red">距离无穷计数</strong>问题，这是距离向量算法的一个固有问题，可采取多种措施来减少出现该问题的概念或减小该问题带来的危害：

- 限制最大路径距离为 15
- 当路由表发生变化时就立即发送更新报文（即"<strong style="color:red">触发更新</strong>"），而不是周期性发送
- 让路由器记录收到某特定路由信息的接口，而不让同一路由信息再通过此接口向反方向传送（即"<strong style="color:red">水平分割</strong>"）



**习题**

<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212000402721.png" alt="image-20230212000402721" style="zoom:50%;" />



### 4.5.3 开放最短路径优先（OSPF）基本工作原理

- 开放最短路径优先 OPSF（**O**pen **S**hortest **P**ath **F**irst），是为了克服 RIP 的缺点在 1989 提出的
  - "开放" 表明 OSPF 协议不是受某一家产商控制，而是公开发表的
  - "最短路径优先" 是因为使用了 Dijkstra 提出的<strong style="color:red">最短路径算法 SPF</strong>
- OSPF 是<strong style="color:red">基于链路状态</strong>的，而不是像 RIP 那样基于距离向量的

- OSPF 采用 SPF 算法计算路由，从算法上保证了<strong style="color:red">不会产生路由环路</strong>

- OSPF <strong style="color:red">不限制网络规模</strong>，更新效率高，<strong style='color:red'>收敛速度快</strong>

- 链路状态是指本路由器都和哪些路由器相邻，以及响应链路的 "代价" （cost）

  - "代价" 用来表示费用、距离、时延、带宽等等，这些都是由网络管理人员来决定

    <img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212002825110.png" alt="image-20230212002825110" style="zoom:25%;" />

- OSPF 相邻路由器之间通过交换**问候（Hello）分组**，建立和维护**邻居关系**

  - Hello 分组封装在 IP 数据报中，发往组播地址 224.0.0.5

    <img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212003231767.png" alt="image-20230212003231767" style="zoom:33%;" />

  - 发送周期为 10s

  - 40s 未收到来自邻居路由器的 Hello 分组，则认为该邻居路由器不可达

    <img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212003337437.png" alt="image-20230212003337437" style="zoom:33%;" />

- 使用 OSPF 的每个路由器都会产生链路状态通告 LSA（Link State Advertisement）。LSA 包含以下内容

  - 直连网络的链路状态信息
  - 邻居路由器的链路状态信息

- LSA 被封装在<strong style="color:red">链路状态更新分组 LSU</strong> 中，采用<strong style="color:red">洪泛法</strong>发送

  <img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212003824397.png" alt="image-20230212003824397" style="zoom:25%;" />

- 使用 OSPF 的每个路由都有一个<strong style="color:red">链路状态数据库 LSDB</strong>,用于存储 LSA

- 通过各路由器洪泛发送封装有自己的 LSU 分组，各路由器的 LSDB 最终将达成一致

- 使用 OSPF 的各路由器基于 LSDB 进行最短路径优先 SPF 计算，构建出各自到达其他路由器的最短路径，即构建各自的路由表

  <img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212004504822.png" alt="image-20230212004504822" style="zoom:33%;" />



**OSPF 的五种分组类型**

![image-20230212004701422](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212004701422.png)

**OSPF 的基本工作原理**

![image-20230212104113222](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212104113222.png)

**OSPF 在多点接入网络中路由器邻居关系的建立**

假如有 $n$ 台路由器连接在同一个多点接入网络中，那么这 $n$ 台路由器互为邻居关系，邻居关系数量为 $\frac{n(n-1)}{2}$，每一台路由器都要向其它 $n-1$ 台路由器发送问候分组和连接更新分组。

- 为了减少发送的分组数量，OSPF 会选择<strong style="color:red">指定路由器DR</strong> （Designated Router）和<strong style="color:red">备用的指定路由器 BDR</strong>（Backup Designated Router）
- 所有的非 DR / BDR 只与 DR / BDR 建立邻居关系
- 非 DR / BDR 之间通过 DR / BDR 交换信息

![image-20230212111345995](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212111345995.png)



为了使 OSPF 能够用于规模大的网络，OSPF 把一个自治系统再划分为若干个更小的范围，叫做<strong style="color:red">区域</strong>（Area）

![image-20230212111811155](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212111811155.png)

- 通过把一个 AS 划分为若干个 Area，可以把利用洪泛法交换链路状态信息的范围局限于每一个区域，而不是自治系统，减少整个网络的通信量
- 区域内路由器：路由器的所有接口都在同一个区域内
- 区域边界路由器：一个接口用于连接自身所在区域，另一个接口用于连接主干区域
- 主干路由器：主干区域内的路由器称为主干路由器（也可以把区域边界路由器看做是主干路由器）
- 自治系统边界路由器：主干区域内专门与本自治系统外的其他自治系统交换路由信息称为自治系统边界路由器



### 4.5.4 边界网关协议 BGP 的基本工作原理

在不同自治系统内，度量路由的"代价"（距离、带宽、费用等）可能不同。因此，对于自治系统之间的路由选择，使用 "代价" 作为度量来寻找最佳路由是不行的

<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212120405673.png" alt="image-20230212120405673" style="zoom:33%;" />

> BGP 只能是力求寻找一条能够到达目的网络且比较好的路由（不能兜圈子），而并非是要寻找一条最佳路由



- 在配置 BGP 时，每个自治系统的管理员要选择至少一个路由器作为该自治系统的 "<strong style="color:red">BGP 发言人</strong>"
- 在不同自治系统的 BGP 发言人要交换信息，首先必须建立 <strong style="color:red">TCP 连接</strong>，端口号为 179
  - 在此 TCP 连接上交换 BGP 报文以建立 BGP 会话
  - 利用 BGP 会话交换路由信息
  - 利用 TCP 连接交换路由信息的两个BGP 发言人，彼此称为对方的<strong style="color:red">邻站</strong>（neighbor）或<strong style="color:red">对等站</strong>（peer）
- BGP 发言人除了运行 BGP 外，还必须运行自己所在自治系统所使用的内部网关协议 IGP，例如 OSPF 或 RIP
- BGP 发言人<strong style='color:red'>交换网络可达性的信息</strong>
- 当 BGP 发言人互相交换了网络可达性的信息后，各 BGP 发言人就根据所采用的策略从收到的路由信息中<strong style='color:red'>找到到达各自治系统较好的路由</strong>。也就是构造出树形结构、<strong style="color:red">不存在回路的自治系统连通图</strong>



<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212121855312.png" alt="image-20230212121855312" style="zoom:50%;" />

![image-20230212130118387](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212130118387.png)



BGP-4 有以下四种报文：

1. OPEN（打开）报文：用来与相邻的另一个 BGP 发言人建立关系，使通信初始化
2. UPDATE（更新）报文：用来通告某一路由的信息，以及列出要撤销的多条路由
3. KEEPALIVE（保活）报文：用来周期性地证实邻站的连通性
4. NOTIFICATION（通知）报文：用来发送检测到的差错



**习题**

![image-20230212131456077](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212131456077.png)



<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212131617126.png" alt="image-20230212131617126" style="zoom: 50%;" />



## 4.6 IPv4 数据报的首部格式

IPv4 数据报首部格式如下：

![image-20230212140949644](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212140949644.png)

> 我们成每个小格子为字段或域

- 版本：占 4 比特，表示 IP 协议的版本。通信双方使用的 IP 协议的版本必须保持一致。目前广泛使用的 IP 协议版本号为 4（即 IPv4）

- 首部长度：占 4 比特，表示 IP 数据报首部的长度。<strong style="color:red">该字段取值以 4 字节为单位</strong>。

  - 最小十进制取值为 5，表示 IP 数据报首部只有 20 字节的固定部分
  - 最大十进制取值为14，表示 IP 数据报首部包含 20 字节固定部分和最大 40 字节可变部分

- 可选字段：长度从 1 字节到 40 字节不等。用来支持<u>排错、测量及安全</u>等措施。可选字段增加了 IP 数据报的功能，但同时也使得 IP 数据报的首部长度成为可变的。这就增加了每一个路由器处理 IP 数据报的开销。实际上可选字段很少使用。

- 填充字段：确保首部长度为 4 字节的整数倍，使用全 0 进行填充。

- 区分服务：TOS，占 8 比特。用来获得更好的服务

- 总长度：占 16 比特，表示 IP数据报的总长度（首部 + 数据载荷）。最大取值为十进制的 65535，以字节为单位

  ![image-20230212143435159](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212143435159.png)

 IP 数据报中的<u>标识、标志、片偏移</u>三个字段共同用于 <strong style='color:red'>IP 数据报分片</strong>

<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212144426621.png" alt="image-20230212144426621" style="zoom:33%;" />

- 标识：占 16 比特，属于同一个数据报的各分片数据报应该具有相同的标识

  > IP 软件维持一个计数器，每产生一个数据报，计数器值加 1，并将此值赋给标识字段

- 标志：占 3 比特，各比特含义如下：

  - DF 位：1 表示不允许分片；0 表示允许分片
  - MF 位：1 表示 "后面还有分片"；0 表示 "这是最后一个分片"
  - 保留位：必须为 0

- 片偏移：占 13 比特，指出分片数据报的数据载荷部分偏移在原数据报的位置有多少个单位，以 8 个字节为单位

![image-20230212150014468](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212150014468.png)



- 生存时间 TTL：占 8 比特

  - 最初以 秒 为单位，最大生存周期为 255 秒；路由器转发 IP 数据报时，将 IP 数据报首部中该字段的值减去 IP 数据报在本路由器上所耗费的时间，若不为 0 则转发，否则就丢弃
  - 现在以 "跳数" 为单位，路由器转发 IP 数据报时，将 IP 数据报首部中该字段的值减 1，若不为 0 则转发，否则就丢弃

  > TTL 的最主要作用：防止 IP 数据报在网络中永久兜圈

- 协议：占 8 比特，指明 IPv4 数据报的数据部分是何种数据单元

  常用协议和相应的协议字段值如下所示：

  | 协议名称   | ICMP | IGMP | TCP  | UDP  | IPv6 | OSPF |
  | ---------- | ---- | ---- | ---- | ---- | ---- | ---- |
  | 协议字段值 | 1    | 2    | 6    | 17   | 41   | 89   |

- 首部检验和：占 16 比特，用来检测首部在传输过程中是否出现差错。比 CRC 检验码简单，称为因特网检验和

  > - IP 数据报没经过一个路由器，路由器都要重新计算首部检验和，因为某些字段的取值随时可能发生变化
  > - 由于 IP 层本身并不提供可靠传输的服务，并且计算首部校验和是一项耗时的操作，因此在 IPv6 中，路由器不再计算首部检验和，从而更快转发 IP 数据报

- 源 IP 地址和目的 IP 地址

  各占 32 比特，用来填写发送该 IP 数据报的源主机 IP 地址和接收该 IP 数据报的目的主机的 IP 地址



**习题**

![image-20230212152702953](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212152702953.png)

![image-20230212152832816](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212152832816.png)

![image-20230212153413205](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212153413205.png)



## 4.7 网际控制报文协议 ICMP

- 为了更有效地转发 IP 数据报和提高交付成功的机会，在网际层使用了网际层控制报文协议 ICMP（**I**nternet **C**ontrol **M**essage **P**rotocol）
- 主机或路由器使用 ICMP 来发送<strong style="color:red">差错报告报文</strong>和<strong style="color:red">询问</strong>
- <strong style="color:red">ICMP 报文被封装在 IP 数据报</strong>中发送



### 4.7.1 ICMP 差错报文

ICMP 差错报告报文共有以下五种：

- 终点不可达：当路由器或主机不能交付数据报时，就向源点发送终点不可达报文。具体可再根据 ICMP 的代码字段细分为<u>目的网络不可达、目的主机不可达、目的协议不可达、目的端口不可达、目的网络未知、目的主机未知</u>等 13 中错误

- 源点抑制：当路由器或主机由于拥塞而丢弃数据报时，就向源点发送源点抑制报文，使源点知道应当把数据报的发送速率放慢

- 时间超过：当路由器收到一个目的 IP 地址**不是自己的 IP 数据报**，会将其生存时间 TTL 字段的值减1，若结果不为 0，则将该 IP 数据报转发出去；若结果为 0，除丢弃该 IP 数据报外，还要向源点发送时间超过报文

  > 此外，当终点在预先规定的时间内不能收到一个数据报的全部数据报片时，就把已收到的数据报片全部丢弃，也会向源点发送时间超过报文

- 参数问题：当路由器或目的主机收到 IP 数据报后，根据其首部中的检验和字段发送首部在传输过程中出现了误码，就丢弃该数据报，并向源点发送参数问题报文

- 改变路由（重定向）：路由器把改变路由报文发送给主机，让主机知道下次应该将数据发送给另外的路由器（可通过更好的路由）



:warning:**注意：以下情况不应该发送 ICMP 差错报告报文**

1. 对 ICMP 差错报告报文不再发送 ICMP 差错报告报文
2. 对第一个分片的数据报片的所有后续数据报片都不发送 ICMP 差错报告报文
3. 对具有多播地址的数据报都不发送 ICMP 差错报告报文
4. 对具有特殊地址 （如：127.0.0.0 或 0.0.0.0 ）的数据报不发送 ICMP 差错报告报文



### 4.7.2 ICMP 询问报文

常见的 ICMP 询问报文有以下两种：

- **回送请求和回答**

  ICMP 回送请求报文是由主机或路由器向一个特定的目的主机发出的询问

  收到此报文的主机必须给源主机或路由器发送 **ICMP 回送回答报文**

  这种询问报文通常用来<strong style="color:red">测试目的站是否可达</strong>及了解其有关状态

- **时间戳请求报文**

  ICMP 时间戳请求报文是请某个主机或路由器回答当前的日期和时间

  在 **ICMP 时间戳回答报文**中有一个 32 位的字段，其中写入的整数代表从 1900 年 1 月 1日起到当前时刻一共有多少秒

  这种询问报文用来<strong style="color:red">进行时钟同步和测量时间</strong>.



### 4.7.3 ICMP 应用

ICMP 主要应用有以下两个：

- 分组网间探测 PING（**P**acket **I**nter**N**et **G**roper）

  - 用来测试主机或路由器的连通性
  - 应用层直接使用网际层的 ICMP （没有通过运输层的 TCP 或 UDP）
  - 使用 ICMP 回送请求和回答报文

- 跟踪路由（traceroute）

  - 用来测试 IP数据报从源主机到达目的主机要进过哪些路由器

  - Windows 系统

    - `tracert` 命令

      ```bash
      tracert www.baidu.com
      ```

    - 应用层直接使用网际层 ICMP

    - 使用 ICMP 回送请求和回答报文以及差错报告报文

  - Unix 版本

    - `traceroute` 命令
    - 在运输层使用 UDP 协议



**:herb:扩展：跟踪路由原理**

![image-20230212170801328](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212170801328.png)

![image-20230212170830012](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212170830012.png)

![image-20230212170906054](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212170906054.png)

- H1 给 H2 发送 ICMP 回送请求报文，该报文封装在 IP 数据报中，IP 数据报首部中的 TTL 值设置为 1，R1 收到该报文后，由于 TTL 的值减 1成为 0，R1 丢弃该报文，并向 H1 发送一个 ICMP 差错报告报文，于是 H1 得到了经过的第一台路由器 IP 地址
- 之后 H1 再给 H2 发送 ICMP 回送请求报文，被封装在 IP 数据报，其中 TTL 的值设置为 2，后面的以此类推
- 直到回送请求的回答报文抵达 H2 后，H2 给 H1 发送 ICMP 回送请求的回答报文，H1 得到最后一站，即目的主机后结束请求



## 4.8 虚拟网络 VPN 和网络地址转换 NAT

### 4.8.1 虚拟专用网 VPN（Virtual Private Network）

<strong style='color:red'>利用公用的因特网</strong>作为本机构各专用网之间的通信载体，这样的专用网又称为虚拟专用网

由于 IPv4 地址紧缺，一个机构能够申请到的 IPv4 地址数量往往远小于本机构所拥有的主机数量。因此，<strong style="color:red">虚拟专用网中的各主机所分配的地址应该是本机构可自由分配的专用地址</strong>，而不是需要申请的、在因特网上使用公有地址

```
专用地址：
10.0.0.0 ~ 10.255.255.255(10/8地址块)
172.16.0.0 ~ 172.31.255.255(172.16/12地址块)
192.168.0.0 ~ 192.168.255.255(192.168/16地址块)
```

![image-20230212173253230](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212173253230.png)

> 从逻辑上看，R1 和 R2 之间是一条直通的点对点链路，称为 IP 隧道技术

上图所示的，同一机构内不同部门的内部网络所构成的虚拟专用网 VPN 又称为<strong style='color:red'>内联网 VPN</strong>

有时一个机构的 VPN 需要有某些外部机构参与进来。这样的 VPN 就成为<strong style='color:red'> 外联网 VPN</strong>

在外地工作的员工需要访问公司的专用网络时，只要在任何地点接入到因特网，运行 PC 中的 VPN 软件，就可以在 PC 和公司的主机之间建立 VPN 隧道，即可访问专用网络中的资源。这种 VPN 称为 <strong style='color:red'>远程接入 VPN</strong>



### 4.8.2 NAT 网络地址转换（Network Address Translation）

虽然因特网采用无分类编址方式来减缓 IPv4 地址空间耗尽的速度，但是由于因特网用户激增，还是不能解决 IPv4 的地址空间即将面临耗尽的危险。

1994 年提出了一种**网络地址转换 NAT** 的方法再次缓解了 IPv4 地址空间即将耗尽的问题。

NAT 能使<strong style='color:red'>大量使用内部专用地址专用网络用户共享少量外部全球地址来访问因特网上的主机和资源</strong>

**工作原理**

1. **私有（专用）网络上的主机发送 IP 数据报给因特网上具有全球 IP 地址的另一台主机**

   <img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212182740202.png" alt="image-20230212182740202" style="zoom: 25%;" />

   > 安装有 NAT 软件的路由器叫做 NAT 路由器

2. 因特网上的主机给源主机发回数据报

   <img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212183139448.png" alt="image-20230212183139448" style="zoom:25%;" />



![image-20230212183627106](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212183627106.png)



# 5 数据链路层

## 5.1 链路层基本概念和重要问题

- 链路（Link）：就是从一个节点到相邻节点的一段物理线路，而中间没有任何其他的交换结点
- 数据链路（Data Link）：是指把实现通信协议的硬件和软件加到链路上，就构成了数据链路
- 数据链路层以<strong style="color:red">帧</strong>为单位传输和处理数据

**数据链路层的三个重要问题**

**01 封装成帧**

![image-20230212190934882](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212190934882.png)



**02 差错检测**

发送方在发送帧之前会基于待发送的数据和检错算法计算出检错码，**并将其封装在帧尾**，接收到在收到帧后就可以根据检错码和检错算法来判断帧在传输过程中是否出现问题

<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212191152180.png" alt="image-20230212191152180" style="zoom:50%;" />



**03 可靠传输**

接收方主机在收到有误码的帧后，是不会接收该帧的，会将其丢弃

- 如果数据链路层向其上层提供的是不可靠传输服务，那么就直接丢弃
- 如果数据链层向其上层提供的是可靠传输服务，那么就需要采取其他措施使得接收方可以重新收到被丢弃的这个帧的正确副本



上述示例，我们所列举的例子都是**使用点对点信道的数据链路层**

当我们使用**广播信道的数据链路层**时，还会具有以下问题：

1. 编址问题：主机 A 、B、D、E 通过一条总线互连，主机 A 发送广播，且仅让 C 能接收，那么就需要需要在帧中封装源地址和目的地址相关信息

<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212192650956.png" alt="image-20230212192650956" style="zoom:25%;" />

2. 多主机同时广播造成碰撞问题

   <img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212193153011.png" alt="image-20230212193153011" style="zoom: 33%;" />

   > 这是共享式局域网通有的问题，使用 CSMA/CD（载波监听多点接入/碰撞检测） 可以解决，后来在有线局域网领域，使用点对点链路和链路交换机的**交换式局域网**取代了共享式局域网
   >
   > <img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212193710524.png" alt="image-20230212193710524" style="zoom:25%;" />

3. 由于无线信道的广播天性，无线局域网使用的仍然是共享信道技术

   > 例如：802.11 局域网的媒体接入控制协议 CSMA/CA（载波监听多点接入/碰撞避免）



## 5.2 封装成帧

封装成帧是指数据链路层<strong style='color:red'>给上层交付的协议数据单元添加帧头和帧尾使之成为帧</strong>

- 帧头和帧尾中包含有重要的控制信息

  <img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212200339641.png" alt="image-20230212200339641" style="zoom:25%;" />

- 帧头和帧尾的作用之一就是<strong style="color:red">帧定界</strong>

  > 在 PPP 帧中的标志位就是帧定界，而 MAC 帧没有帧定界，但会在物理层添加一个前导码，前导码中前 7 个字节为前同步码，后一个字节为帧开始定界符，另外以太网还规定了 96 比特的帧间间隔，所以不需要帧结束定界符
  >
  > <img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212200946809.png" alt="image-20230212200946809" style="zoom:25%;" />

透明传输是指：<strong style="color:red">数据链路层对上层交付的传输数据没有任何限制</strong>，就好像数据链路层不存在一样

- 在数据链路层中，发送帧之前需要对帧的数据进行扫描，每出现一个帧定界符或转义字符，就在其前面添加转义字符

  <img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212202531643.png" alt="image-20230212202531643" style="zoom:33%;" />

- 面向字节的物理链路使用字节填充（或字符填充）的方法实现透明传输

- 面向比特的物理链路使用比特填充的方法实现透明传输

例如：在比特流中如果帧定界符为 `01111110`，那么既可以发送帧之前，对帧的数据部分进行扫描，当出现连续的五个 1，就在后面填充一个 0，接收方在收到时，只需要剔除即可

![image-20230212203118068](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212203118068.png)



**习题**

![image-20230212203345340](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212203345340.png)



为提高帧的传输效率，应当使<strong style="color:red">帧的数据部分的长度尽可能大些</strong>

> 考虑到差错控制等多种因素，每一种数据链路层协议都规定了帧的数据部分长度上限，即<strong style='color:red'>最大传送单元MTU</strong>（Maximum Transfer Unit）

<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212203740398.png" alt="image-20230212203740398" style="zoom:50%;" />



## 5.3 差错检测

实际的通信链路都不是理想的，比特在传输过程中可能会产生差错：1 变成  0，而 0 也可能变成 1,。这称为 <strong style="color:red">比特差错</strong>

- 在一段时间内，传输错误的比特占所传输比特总数的比率称为误码率BER（Bit Error Rate）
  $$
  BER=\frac{传输错误的比特}{传输的总比特数}
  $$

- 使用<strong style="color:red">差错检测码</strong>来检测数据在传输过程中是否产生了比特差错，是数据链路层需要解决的问题之一

  <img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212205907332.png" alt="image-20230212205907332" style="zoom:25%;" />

  > 在 MAC 帧 和 PPP 帧尾部分中都有一个帧检验序列 FCS 字段，作用就是让接收方的数据链路层据此判断帧在传输过程是否出现了误码



**差错检测方法1：奇偶检验法**

- 在待发送的数据后面<strong style="color:red">添加 "1" 为奇偶检验位</strong>，使整个数据（包括所添加的检验位在内）中 <strong style="color:red">"1" 的个数</strong>为奇数（奇校验）或偶数（偶校验）
  - 如果有奇数个位发送误码，则奇偶性发生变化，可以检查误码
  - 如果有偶数个位发生误码，则奇偶性不发生变化，不能检查出误码（漏检）

由于奇偶校验出现**漏检**率很高，数据链路层一般不会采用这种检错方法



**差错检验方法2：循环冗余校验CRC（Cyclic Redundancy Check）**

1. 收发双发约定好一个<strong style="color:red">生成多项式 G(x)</strong>
2. 发送法基于待发送的数据和生成多项式计算差错检测码（<strong style="color:red">冗余码</strong>），将其添加到待传输数据的后面一起传输
3. 接收方通过生成多项式来计算收到的数据是否产生了误码

<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212212324513.png" alt="image-20230212212324513" style="zoom: 33%;" />



**示例**

![image-20230212212623743](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212212623743.png)



![image-20230212213111552](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212213111552.png)

![image-20230212213232981](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212213232981.png)



:warning:**注意**

- 检错码只能检测出帧在传输过程中出现了差错，但并不能定位错误，因此<strong style="color:red">无法纠正错误</strong>
- 要想纠正传输中的差错，可以使用冗余信息更多的<strong style="color:red">纠错码</strong>进行<strong style="color:red">前向纠错</strong>。但纠错码的开销比较大，在<strong style="color:red">计算机网络中较少使用</strong>
- 循环冗余校验 CRC 有很好的检错能力（<strong style="color:red">漏检率非常低</strong>），虽然计算比较复杂，但非常易于<strong style="color:red">用硬件实现</strong>，因此广泛应用于数据链路层
- 在计算机网络中通常采用<strong style="color:red">检错重传的方式来纠正传输中的差错</strong>，<strong style="color:red">或者仅仅是丢弃检测到差错的帧</strong>，这取决于数据链层向其上提供的是可靠传输服务还是不可靠传输服务



## 5.4 可靠传输

- 使用**差错检测技术**（例如循环冗余校验 CRC），接收方的数据链路层就可检测出帧在传输过程中是否产生了**误码**（比特错误）
- 数据链路层向上层提供的服务类型
  - **不可靠传输服务**：<strong style="color:red">仅仅丢弃有误码帧</strong>，其它什么都不做
  - **可靠传输服务**：想办法实现<strong style="color:red">发送端发送什么，接收端就接收什么</strong>
- 一般情况下，**有线链路**的误码率比较低，为了减小开销，并<strong style="color:red">不要求数据链路层向上提供可靠传输服务</strong>，即使出现了误码，可靠传输的问题由其上层处理
- 无线链路易受到干扰，误码率比较高，因此要求数据链路层必须向上层提供可靠的传输服务

:bell:**注意**

- **比特差错**只是传输差错中的一种

- 从整个计算机网络体系结构来看，传输差错还包括<strong style="color:red">分组丢失</strong>、<strong style="color:red">分组失序</strong>以及<strong style="color:red">分组重复</strong>

- 分组丢失、分组失序以及分组重复这些传输差错，一般不会出现在数据链路层，而会出现在其上层

- 可靠传输服务并不仅局限于数据链路层，其他各层均可选择实现可靠传输

  ![image-20230212224518880](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212224518880.png)

- 可靠传输的实现比较复杂，开销也比较大，是否使用可靠传输取决于应用需求



## 5.5 可靠传输的实现机制

可靠传输的实现机制主要有三种：

- 停止-等待协议 SW
- 回退 N 帧协议 GBN
- 选择重传协议 SR

> 这三种可靠传输实现机制的应用并不仅局限于数据链路层，还可以应用到计算机网络体系中的各层协议中

### 5.5.1 停止-等待协议 SW（Stop-Wait）

**设置超时计时器**

<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212230214142.png" alt="image-20230212230214142" style="zoom:50%;" />

**为数据分组编号**

<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212230450974.png" alt="image-20230212230450974" style="zoom:50%;" />

**为确认分组编号**

![image-20230212230823821](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212230823821.png)

:warning:**注意事项**

1. 接收端检测到数据分组有误码时，将其丢弃并等待发送方的超时重传，但对于误码率较高的点对点链路，为使发送方**尽早重传**，**也可以给发送方发送 NAK 分组**
2. 为了让接收方能够判断所收到的数组分组是否重复的，需要给**数据分组编号**，由于停止-等待协议的停等特性，**只需 1 个比特编号即可，即编号 0 和 1**
3. 为了让发送方能够判断所收的 ACK 分组是否重复，需要给  **ACK 分组编号**，所用比特数量与数据分组编号所用比特数量一样。数据链路层一般不会出现 ACK 分组迟到的情况，因此**在数据链路层实现 停等协议 可以不用给 ACK 分组编号**
4. 超时计时器设置的重传时间应仔细选择，一般可以将重传时间选为**略大于 "从发送方到接收方的平均往返时间"**
   - 在数据链路层点对点的往返时间比较确定，重传时间比较好设定
   - 然而在运输层，由于端到端的往返时间非常不确定，设置合适的重传时间有时并不容易

![image-20230212234009033](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212234009033.png)

**举例**

![image-20230212234525269](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212234525269.png)

> $2\times10^8 m/s$ 为波在光纤中的传播速度

从上图可知：

- 当往返时延 $RTT$ 远大于数据帧发送时延 $T_D$ 时（例如使用卫星链路），信道利用率非常低
- 若出现重传，则对于传送有用的数据信息来说，信道利用率还要降低
- 为克服停止-等待协议的缺点，就产生了另外两种协议，即回退 N 帧协议 GBN 和选择重传协议 SR



**习题**

![image-20230212235417047](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212235417047.png)



### 5.5.2 回退 N 帧协议 GBN（Go-Back-N）

如下图，前面我们说过， 停等协议信道利用率极低，而如果像下图一样采用流水线式的传送方式，原来发送 1 个分组的时间就可以发送 5 个分组，大大提高了信道利用率

![image-20230212235748087](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230212235748087.png)



对于回退 N 帧协议，我们做出以下规定：

1. 采用 $n$ 个比特给分组编号，即序号 $0  \sim  2^n-1$
2. 发送窗口的尺寸 $W_t$ 的取值：$1 < W_T \leq 2^n-1$
3. 接收窗口的尺寸 $W_R$ 的取值为：$W_R=1$



以下示例 $n=3, \ W_T = 5$ 

**情况1：无差错传送**

![image-20230213002240481](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213002240481.png)

- 发送方将序号落在发送窗口内的 0-4 号数据分组依次连续发送出去，经过互联网传输，正确到达了接收方
- 接收方按序接收它们，每接收一个，接收窗口就向前滑动一个位置，并给发送方发送针对所接收分组的确认分组
- 0-4 号确认分组经过互联网的传输正确到达了发送方，发送方每接收一个，发送窗口就向前滑动一个位置，如此就有新的序号进入发送窗口
- 发送方可以将收到确认的分组从缓存中删除，接收方可以将已收到的数据分组交付上层处理



**累计确认**

接收方不一定要对收到的数据分组逐个发送确认，而是可以在收到几个数据分组后（由具体实现决定），<strong style="color:red">对按序到达的最后一个数据分组发送确认</strong>。ACKn 表示序号为 n 及以前的所有数据分组都已正确接收。

使用累计确认的优点：<strong style="color:red">即使确认分组丢失，发送方也可能不必重传</strong>，其他好处如下：

- 减小接收方的开销
- 减少对网络资源的占用

> 例如：接收方在确认收到分组0-1后发送 ACK1 给发送方，之后确认收到分组0-4 后发送 ACK4 给发送方，过程中即使 ACK1 丢失也没有关系，因为 ACK4 确认被接收则代表 0-4 分组已正确被接收方接收

累计确认的缺点：不能向发送方及时反应出接收方已经正确接收的分组的信息



当出现差错时，接收方会给发送方发送对之前已正确接收报文重复的确认，发送方收到重复确认，就知道之前所发送的数据分组出现了差错，于是可以不等超时计时器超时就立刻重传。至于收到几个重复确认就立刻重传，由具体实现决定。

<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213112437972.png" alt="image-20230213112437972" style="zoom:33%;" />

若发送窗口尺寸超过了规定的最大上限7，例如发送窗口尺寸为 8，那么当第一次的确认报文 ACK7 丢失，发送方超时重传，重复发送 0-7 号数据，接收方由于分组编号为 0-7，无法辨别新、旧数据分组

<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213112717624.png" alt="image-20230213112717624" style="zoom:33%;" />

:spiral_notepad:**总结**

<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213113729835.png" alt="image-20230213113729835" style="zoom:33%;" />

> - 回退 N 帧协议**在流水线传输的基础**上利用发送窗口来限制发送方发送数据分组的数量，是一种**连续 ARQ协议**（Automatic Repeat-reQuest，自动重传请求）
> - 在协议的工作过程中发送窗口和接收窗口不断向前滑动，因此这类协议又称为<u>滑动窗口协议</u>
> - 由于回退 N 帧协议的特性，当通信线路质量不好时，其信道利用率不比停止-等待协议高



**习题**

<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213123252897.png" alt="image-20230213123252897" style="zoom:50%;" />



### 5.5.3 选择重传协议 SR（Selective Repeat）

SR 是对 GBN 的改进，使得只重传出现误码的数据分组。因此，接收窗口尺寸 $W_R$ 不应等于 1 （而应该大于 1），以便<strong style="color:orange">接收方先收下失序到达但无误码并且序号落在接收窗口内的那些数据分组</strong>，等到所缺分组收齐后再一并送交上层，这就是<strong style="color:orange">选择重传协议</strong>

> :warning:注意：选择重传协议为了使发送方仅重传出现差错的分组，接收方不能再采用累计确认，而需要对每个正确接收到数据分组做逐一确认



对选择重传协议规定如下：

1. 采用 $n$ 个比特给分组编号，即序号 $0  \sim  2^n-1$
2. 发送窗口的尺寸 $W_T$ 的取值：$1 < W_T \leq 2^{n-1}$
3. 接收窗口的尺寸 $W_R$ 的取值：$W_R=W_T$

本例取 $n=3,\ W_T=4$

![image-20230213132251475](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213132251475.png)

![image-20230213132600915](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213132600915.png)



**对发送方和接收方的窗口尺寸问题进行探讨**

- 发送方的发送窗口尺寸 $W_T$ 必须满足：$1<W_T \leq 2^{n-1}$，其中 n 是构成分组序号的比特数量
  - 若 $W_T=1$：与停止-等待协议相同
  - 若 $W_T>2^{n-1}$：造成接收方无法分辨新、旧数据分组的问题
- 接收方的接收窗口尺寸 $W_R$ 必须满足：$1<W_R \leq W_T$
  - 若 $W_R=1$：与回退 N 帧协议相同
  - 若 $W_R>W_T$：无意义



**$W_T>2^{n-1}$ 的情况**

<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213135528573.png" alt="image-20230213135528573" style="zoom:50%;" />

> 累计重传由于接收窗口的尺寸大小限制为 1，不会出现上述的问题



**总结**

![image-20230213135914748](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213135914748.png)



**习题**

<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213140135178.png" alt="image-20230213140135178" style="zoom:50%;" />



## 5.6 点对点协议 PPP（Point-to-Point Protocol）

点对点协议 PPP 是目前使用最广泛的点对点数据链路层协议

> PPP 协议是因特网工程任务组 IETF 在 1992 年指定的。经过 1993 年和 1994 年的修订，现在 PPP 协议已成为因特网的正式标准【RFC1661, RFC1662】

<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213150641888.png" alt="image-20230213150641888" style="zoom:50%;" />

> - 用户计算机在获取 ISP 所分配的合法 IP 地址后，才能成为因特网上的主机，而用户计算机在与 ISP 进行通信时，所使用的数据链路层协议通常就是 PPP 协议
> - 在 1999 年公布的在以太网上运行的 PPP 协议，即 PPP over Ethernet，简称为 PPPoE，它使得 ISP 可以通过 DSL、电路调制解调器、以太网带宽接入技术、以太网接口的形式为用户提供接入服务
> - 点对点协议也广泛应用于广域网路由器之间的专用线路



PPP 协议为在点对点链路传输各种数据报提供了一个标准方法，主要由以下三个部分构成：

- 对各种协议数据报的封装方法（封装成帧）

- 链路控制协议 LCP

  > 用于建立、配置以及测试数据链路的连接

- 一套网络控制协议 NCPs

  > 其中的每一个协议支持不同的网络层协议

<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213153347777.png" alt="image-20230213153347777" style="zoom:25%;" />



### 01 PPP 协议帧格式

<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213154121051.png" alt="image-20230213154121051" style="zoom:33%;" />

- 标志（Flag）字段：PPP 帧的定界符，取值为 0x7E
- 地址（Address）字段：取值为 0xFF，预留（目前没有什么作用）
- 控制（Control）字段：取值为 0x03，预留（目前没有什么作用）
- 协议（Protocol）字段：指明帧的数据部分送交哪个协议处理
  - 取值为 0x0021 表示：帧的数据部分为 IP 数据报
  - 取值为 0xC021 表示：帧的数据部分为 LCP 分组
  - 取值为 0x8021 表示：帧的数据部分为 NCP 分组
- 帧检验序列（Frame Check Sequence）字段：CRC 计算出的校验位



### 02 透明传输

![image-20230213160141624](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213160141624.png)

当帧的数据部分出现与帧定界相同的数值，即 01111110，十六进制为 0x7E，需要对帧的数据部分做出处理：

- 如果是面向字节的异步链路：采用字节填充法，插入 "转移字符"
- 如果是面向比特的同步链路：采用比特填充法，即在每五个相同的 1 后面添加一个 0



**字节填充法**

![image-20230213164003070](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213164003070.png)

发送方的处理：

- 出现的每一个 7E（PPP 帧的定界符）字节转变成 2 字节序列（7D, 5E）

  > 7D 对应 "~"，5E 对应 "^"
- 出现的每一个 7D（转义字符）字节转变成 2 字节序列（7D, 5D）
- 出现的每一个 ASCII 码的控制字符（数值小于 0x20 的字符），则在该字符前面插入一个 7D 字节，同时将该字符的编码加上 0x20

  > 0x20 即 "space"，功能字符为 0-31，"0x20" 为 32

接收方的处理：进行**反变换**即可恢复出原来的帧的数据部分



**比特填充法**

![image-20230213164647921](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213164647921.png)

- 发送方的处理：对帧的数据部分进行扫描（一般由由硬件实现）。<strong style="color:red">只要发现 5 个连续的比特 1，就立即填充 1 个比特 0</strong>
- 接收方的处理：对帧的数据部分进行扫描（一般由由硬件实现）。<strong style="color:red">只要发现 5 个连续的比特 1，就把其后的 1 个比特 0 删除</strong>



### 03 差错检测

<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213165308405.png" alt="image-20230213165308405" style="zoom:50%;" />

校验所用的多项式为：
$$
CRC-CCITT=X^{16}+X^{12}+X^{5}+1
$$

> RFC 1662 的附录部分给出了 FCS 的计算方法的 C 语言实现（查表发）

```
接收方每收到一个 PPP 帧，就进行 CRC 检验。若 CRC 检验正确，就收下这个帧；反之，就丢弃这个帧。使用 PPP 的数据链路层向上不提供可靠传输服务
```



### 04 PPP 工作状态

![image-20230213165927467](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213165927467.png)



## 5.7 媒体接入控制

### 5.7.1 基本概念

如下图，有多台主机连接到一根同轴电缆上，它们共享这根传输媒体，形成了一个总线型的局域网，各主机竞争使用主线，随机地在信道上发送数据，如果恰巧有两个或更多的站点在同一时刻发送数据，那么信号在共享媒体上就要产生碰撞，即发生了冲突，使得这些站点的发送都失败

![image-20230213171411457](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213171411457.png)

- 共享信道要着重考虑的一个问题就是<strong style="color:red">如何协调多个发送和接收站点对一个共享传输媒体的占用</strong>，即<strong style="color:red">媒体接入控制 MAC</strong>（Media Access Control）

![image-20230213173118638](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213173118638.png)

> 采用令牌传递协议（即使用分散控制）的典型网络有 IEEE 802.5 令牌环网、IEEE 802.4 令牌总线网、光纤分布式数据接口 FDDI等，这些网络由于市场竞争已经退出历史舞台

### 5.7.2 静态划分信道

- 复用（Multiplexing）是通信技术中一个重要概念。复用就是通过一条物理线路同时传输多路用户的信号
- 当网络中传输媒体的传输容量大于多条单一信道传输的总通信量，可利用复用技术在一条物理线路上建立多条通信信道来充分利用传输媒体的带宽

![image-20230213180645550](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213180645550.png)

常见的复用技术有四类：

**01 频分复用 FDM**

![image-20230213181041520](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213181041520.png)



**02 时分复用 TDM**

![image-20230213181410703](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213181410703.png)



**03 波分复用 WDM**

![image-20230213181624536](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213181624536.png)



**04 码分复用**

![image-20230213181932214](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213181932214.png)

![image-20230213182007299](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213182007299.png)

![image-20230213182153861](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213182153861.png)

无法理解这一章节内容，后面再补充



### 5.7.3 随机接入 -CSMA/CD 协议

<strong style="color:#0368D9">载波监听</strong><strong style="color:#088751">多址接入</strong><strong style="color:#FE9C3C">/碰撞检测</strong> <strong style="color:#0368D9">CS</strong><strong style="color:#088751">MA</strong><strong style="color:#0368D9">/CD</strong><font color="#0368D9">（**C**arrier **S**ense</font> <font color='#088751'>**M**ultiple **A**ccess</font><font color="#FE9C3C">/**C**ollision **D**etection</font>）

- <font color="#0368D9">**载波监听 CS**：每一个站点在发送帧之前先要检测一下总线上是否有其他站点在发送帧（"先听后说"）</font>
  - <font color="#0368D9">若检测到总线空闲 96 比特时间，则发送这个帧</font>
  - <font color="#0368D9">若检测到总线忙，则继续检测并等待总线转为空闲 96 比特时间，然后发送这个帧</font>
- <font color='#088751'>**多址接入 MA**：</font><font color='#088751'>多个站点连接在一条总线上，竞争使用总线</font>
- <font color="#FE9C3C">**碰撞检测 CD** ：每一个正在发送帧的站点边发送边检测碰撞（"边说边听"）</font>
  - <font color="#FE9C3C">一旦发现总线上出现碰撞，则立即停止发送，退避一段随机时间后再次发送（"一旦冲突、立即停说、等待时机、重新再说"）</font>

![image-20230213185218035](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213185218035.png)

**争用期**

![image-20230213190638668](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213190638668.png)

> 之所以不能超过 $5120 m$ 的原因：电磁波在光纤的传播速率为 $2 \times 10^8 \ m/s$，乘上 $51.2us$，并算上返程 $\div 2$，就是 $5120 m$

**最小帧长**

![image-20230213191437423](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213191437423.png)

- <strong style='color:red'>以太网规定最小帧长为 64 字节</strong>，即 512 比特（512比特时间即为争用期）
  - 如果要发送的数据非常少，那么必须加入一些加入一些填充字节，使帧长不小于 64 字节
- 以太网的<strong style="color:red">最小帧长确保主机可在帧发送完成之前就检测到该帧的发送过程中是否遭遇了碰撞</strong>
  - 如果在争用期（供发送 64 字节的时间）没有检测到碰撞，那么后续发送的数据就一定不会发生碰撞
  - 如果在争用期内检测到碰撞，就立即停止发送，这时已经发送的数据一定小于 64 字节，因此<strong style="color:red">凡长度小于 64 字节的帧都是由于碰撞而异常终止的无效帧</strong>

**最大帧长**

![image-20230213194906650](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213194906650.png)



**截断二进制指数退避算法**

![image-20230213200118055](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213200118055.png)

- 若连续多次发生碰撞，就表明可能有较多的主机参与竞争信道。但使用上述退避算法可<strong style="color:red">使重传需要推迟的平均时间随重传次数而增大</strong>（这也称为<strong style="color:red">动态退避</strong>），因而减小发生碰撞的概率，有利于整个系统的稳定性
- <strong style="color:red">当重传达 16 次仍不能成功时</strong>，表明同时打算发送帧的主机太多，以至于连续发生碰撞，则<strong style="color:red">丢弃该帧</strong>，并向高层报告



**信道利用率**

![image-20230213201309475](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213201309475.png)



**帧发送流程图**

![image-20230213201432640](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213201432640.png)



**帧接收流程图**

![image-20230213201546769](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213201546769.png)



**习题**

![image-20230213201906636](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213201906636.png)

![image-20230213202423337](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213202423337.png)



![image-20230213202902306](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213202902306.png)

![image-20230213203017624](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213203017624.png)



:warning:**注意**

- CSMA/CD 协议曾经用于各种总线结构以太网和双绞线以太网的早期版本中
- 现在的以太网基于交换机和全双工连接，不会有碰撞，因此没有必要使用 CSMA/CD 协议



### 5.7.4 随机接入——CSMA/CA 协议

上一节，我们介绍了<u>总线局域网使用的协议：CSMA/CD</u> ，本节课，我们将介绍<u>无线局域网使用的协议：CSMA/CA</u>

<strong style="color:#0368D9">载波监听</strong><strong style="color:#088751">多址接入</strong><strong style="color:#FE9C3C">/碰撞避免</strong> <strong style="color:#0368D9">CS</strong><strong style="color:#088751">MA</strong><strong style="color:#0368D9">/CD</strong><font color="#0368D9">（**C**arrier **S**ense</font> <font color='#088751'>**M**ultiple **A**ccess</font><font color="#FE9C3C">/**C**ollision **A**voidance</font>）

==既然 CSMA/CD 协议已成功地应用于使用广播信道的有线局域网，那么同样使用广播信道的无限局域网能不能也使用 CSMA/CD 协议呢？==

- <strong style="color:red">在无线局域网中，仍然可以使用载波监听多址接入 CSMA</strong>，即在发送帧之前先对传输媒体进行载波监听。若发现有其他站在发送帧，就推迟发送

- <strong style="color:red">在无线局域网中，不能使用碰撞检测 CD</strong>

  - 由于无线信道的传输条件特殊，其信号强度的动态范围非常大，无线网卡接收的信号强度往往会远远小于发送信号的强度（可能相差百万倍）。<strong style="color:red">如果要在无限网卡上实现碰撞检测 CD，对硬件的要求非常高</strong>

  - 即使能够在硬件上实现无线局域网的碰撞检测功能，但由于无线电波传播的特殊性（<strong style="color:red">存在隐蔽站问题），进行碰撞检测的意义不大</strong>

    ![image-20230213211156514](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213211156514.png)

  



- 802.11 无限局域网使用 CSMA/CA 协议



## 5.8 MAC 地址、IP 地址以及 ARP 协议

- MAC 地址是以太网的 MAC 子层所使用的地址，<strong style="color:red">属于数据链路层</strong>
- IP 地址是 TCP / IP 体系结构网际层所使用的地址，<strong style="color:red">属于网际层</strong>
- ARP 协议属于 TCP / IP 体系结构的网际层，其作用是<u>已知设备所分配到的 IP 地址，使用 ARP 协议可以通过该 IP 地址获取到设备的 MAC 地址</u>，属于网际层



### 5.8.1 MAC 地址（Media Access Control Address）

- 当多个主机连接在同一个广播信道上，要想实现两个主机之间的通信，则每个主机都必须有一个唯一的标识，即一个数据链路层地址

  ![image-20230213212754728](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213212754728.png)

- 在每个主机发送的<strong style="color:#31A1D4">帧中必须携带标识发送主机和接收主机的地址</strong>。由于这类地址是用于媒体接入控制 MAC（**M**edia **A**ccess **C**ontrol），因此这类地址也被称为 <strong style="color:#31A1D4">MAC 地址</strong>

  - MAC 地址一般被固化在网卡（网络适配器）的电可擦可编程只读存储器 EEPROM，因此 MAC 地址也被称为**硬件地址**
  - MAC 地址有时也被称为 **物理地址**。<strong style="color:red">请注意：这并不意味这 MAC 地址属于网络体系结构中的物理层</strong>
  
- 一般情况下，用户主机会包含两个网络适配器：有线局域网络适配器（有线网卡）和无线局域网络适配器（无线网卡）。每个网络适配器都有一个全球唯一的 MAC 地址。而交换机和路由器往往拥有更多的网络接口，所以会有更多的 MAC 地址。综上所述，<strong style="color:red">MAC 地址是对网络上各接口的唯一标识，而不是对网络各设备的唯一标识</strong>

![image-20230213215348547](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213215348547.png)

> 我们可以自行查阅已分配的 OUI：https://standards-oui.ieee.org/oui/oui.txt

![image-20230213220016796](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213220016796.png)

> 对于使用 EUI-48 空间的应用程序，IEEE 的目标寿命为 100 年（直到 2080 年），但是鼓励采用 EUI-64 作为替代



**IEEE 802 局域网的 MAC 地址发送顺序**

![image-20230213220236260](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213220236260.png)



**单播 MAC 地址举例**

![image-20230213220439705](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213220439705.png)



**广播 MAC 地址举例**

![image-20230213220614547](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213220614547.png)



**多播 MAC 地址举例**

![image-20230213221055048](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213221055048.png)

> 判断多播地址的方法：若第一个字节 $b_0$ 十六进制数不能整除 2（1、3、5、7、9、B、D、F）或者直接看其二进制数最后一个位是否为 1，如果是，则为多播地址

:warning:注意：给主机配置多播组列表进行私有应用时，不得使用公有的标准多播地址



**随机 MAC 地址**

美国国家安全局有一套系统，通过监视电子设备的 MAC 地址来跟踪城市中每个人的行动，这里用到的就是 随机 MAC 地址。



### 5.8.2 IP 地址（Internet Protocol Address）

IP 地址是因特网（Internet）上的主机和路由器所使用的地址，用于标识两部分信息：

- 网络编号：标识因特网上数以百万计的网络
- 主机编号：标识同一网络上不同主机（或路由器各接口）

很显然，之前介绍的 MAC 地址不具备区分不同网络的功能

- 如果只是一个单独的网络，不接入因特网，可以只适用 MAC 地址（这不是一般用户的应用方式）
- 如果主机所在的网络要接入因特网，则 IP 地址和 MAC 地址都需要使用



**从网络体系结构看 IP 地址和 MAC 地址**

![image-20230213224609885](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213224609885.png)



**数据报在转发过程中 IP 地址和 MAC 地址的变化情况**

![image-20230213224928048](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213224928048.png)

- 数据包在转发过程中<strong style="color:red">源 IP 地址和目的 IP 地址保持不变</strong>
- 数据报在转发过程中<strong style="color:red">源 MAC 地址和目的 MAC 地址逐个链路（或逐个网络）改变</strong>

**习题**

![image-20230213225439505](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213225439505.png)



### 5.8.3 地址解析协议 ARP （Address Resolution Protocol）

![image-20230213225918087](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213225918087.png)

![image-20230213230041984](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213230041984.png)

![image-20230213230144809](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213230144809.png)

![image-20230213230236461](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213230236461.png)



:spiral_notepad:**总结**

- 源主机在自己的 <strong style="color:red">ARP 高速缓存表</strong> 中查找目的主机的 IP 地址所对应的 MAC 地址，若找到了，则可以封装 MAC 帧进行发送；若找不到，则发送 <strong style="color:red">ARP 请求（封装在广播 MAC 帧中）</strong>
- 目的主机收到 ARP 请求后，将源主机的 IP 地址与 MAC 地址记录到自己的 ARP 高速缓存表中，然后给源主机发送 <strong style="color:red">ARP 响应（封装在单播 MAC 帧中）</strong>
- 源主机收到 ARP 响应后，将目的主机的 IP 地址与 MAC 地址记录到自己的 ARP 高速缓存表中，然后就可以封装之前想发送的 MAC 帧并发送给目的主机
- <strong style="color:red">ARP 的作用范围：逐段链路或逐个网络使用</strong>
- 除 ARP 请求和响应外，ARP 还有类型的报文（例如：用于检查 IP 地址冲突的 "无故 ARP、免费 ARP"）
- ARP 没有安全验证机制，<strong style='color:red'>存在 ARP 欺骗（攻击）</strong>



## 5.9 集线器和交换机的区别

![image-20230213232601336](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213232601336.png)

![image-20230213232735226](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213232735226.png)

![image-20230213232927108](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213232927108.png)

> 交换机和集线器相比，拥有一个优势，就是：会将单播帧发送给目的主机，而不像集线器那样给所有主机发送一片，然后由各主机的数据链路层进行取舍

![image-20230213233254111](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213233254111.png)

![image-20230213233930720](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213233930720.png)



:spiral_notepad:**总结**

- 集线器 HUB
  - 早期以太网的互连设备
  - 工作在 OSI 体系结构的物理层
  - 对接收到的信号进行放大、转发
  - 使用集线器作为互连设备的以太网仍然属于共享总线式以太网。集线器互连起来的所有主机共享总线带宽，属于同一个碰撞域或广播域
- 交换机 SWITCH
  - 目前以太网中使用最广泛的互连设备
  - 工作在 OSI 体系结构的数据链路层（也包括物理层）
  - 根据 MAC 地址对帧进行转发
  - 使用交换机作为互连设备的以太网，称为交换式以太网。交换机可以根据 MAC 地址过滤帧，即隔离碰撞域
  - 交换机的每个接口都是一个独立的碰撞域



## 5.10 以太网自学习和转发帧的流程

- 以太网交换机工作在<strong style="color:red">数据链路层（也包括物理层）</strong>
- 以太网交换机收到帧后，在帧交换表中查找<strong style="color:red">帧的目的 MAC 地址所对应的接口号</strong>，然后通过该接口转发帧
- 以太网交换机是一种即插即用设备，刚上电启动时其内部的帧交换表示空的。随着网络中各主机间的通信，以太网交换机通过<strong style="color:red">自学习算法自动建立帧交换表</strong>

![image-20230213235551958](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230213235551958.png)



**习题**

![image-20230214000359478](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230214000359478.png)



![image-20230214000450437](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230214000450437.png)



![image-20230214000910828](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230214000910828.png)

> 这里需要知道当帧交换表中没有记录目的地址的转发端口号，需要先通过盲目转发，之后如果通过自学习有了明确的目的地址的端口号，就可以进行明确转发



:spiral_notepad:**对自学习和转发帧的流程的总结**

1. 收到帧后进行<strong style="color:red">登记</strong>，登记内容为<strong style="color:red">帧的源 MAC 地址</strong>及进入交换机的<strong style="color:red">接口号</strong>
2. 根据帧的目的 MAC 地址和交换机的帧交换表对帧进行转发，有如下三种情况：
   - 明确转发：交换机知道应当从那个（或哪些）接口转发该帧（单播、多播、广播）
   - 盲目转发：交换机不知道应当从那个端口转发帧，只能将其<u>通过除进入交换机的接口外的其他所有接口转发</u>（也称为 泛洪）
   - 明确丢弃：交换机知道不应该转发该帧，将其丢弃

帧交换表中的每条记录都有自己的有效时间，到期删除，原因如下：

- 交换机的接口改接了另一台主机
- 主机更换了网卡

> 即 MAC 地址和端口号并不是固定的



# 6 物理层

## 6.1 物理层的基本概念

![image-20230221234824853](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230221234824853.png)

物理层中用来连接各种网络设备的传输媒体种类众多，大致可以分为以下两类：

- 导引型传输媒体

  - 双绞线
  - 同轴电缆
  - 光纤

- 非导引型传输媒体

  - 微波通信（2 ~ 40GHz）

    > 例如：使用 2.46 GHz 和 5.8 GHz 频段的 WIFI

物理层就是<strong style="color:red">为了解决在各种传输媒体上传输比特 0 和比特 1 的问题，进而给数据链路层提供 "透明" 传输比特流的服务</strong>

>所谓 "透明" 是指数据链路看不见，也需看见物理层是使用什么方法来传输比特 0 和比特 1，它只管享受物理层提供的比特流传输服务即可

物理层为了解决在各种传输媒体上传输比特 0 和比特 1 的问题，主要有以下四个任务：

- 机械特性：指明接口所用接线器的<strong style="color:red">形状和尺寸、引脚数目和排列顺序、固定和锁定装置</strong>
- 电气特性：在接口电缆的各条线上出现的<strong style="color:red">电压的范围</strong>
- 功能特性：指明某条线上出现的<strong style="color:red">某一电平的电压表示何种意义</strong>
- 过程特性：指明对于不同功能的<strong style="color:red">各种可能事件的出现顺序</strong>

:spiral_notepad:**总结**

- 物理层考虑的是怎样才能在连接各种计算机的传输媒体上传输数据比特流
- 物理层为数据链路层屏蔽了各种传输媒体的差异，使数据链路层只需要考虑如何完成本层的协议和服务，而不必考虑网络具体的传输媒体是什么



## 6.2 物理层下的传输媒体

> :warning:**注意：传输媒体并不属于计算机网络体系结构的任何一层，如果非要将它添加到体系结构中，那只能就将其放在物理层之下**

传输媒体可以分为两类：<u>导引型传输媒体和非导引型传输媒体</u>

- 在导引型传输媒体中，<strong style="color:red">电磁波被导引沿着固体媒体传播</strong>，常见的导引型传输媒体有：同轴电缆、双绞线、光纤、电力线
- 非导引型传输媒体，是指<strong style="color:red">自由空间</strong>，可使用的电磁波有：无线电波、微波、红外线、可见光



### 01 同轴电缆

<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230222105051143.png" alt="image-20230222105051143" style="zoom:50%;" />

- 基带同轴电缆（$50\Omega$）：数字传输，过去用于局域网
- 宽带同轴电缆（$75\Omega$）：模拟传输，目前主要用于有线电视

> 同轴电缆价格较贵且布线不够灵活和方便，随着集线器的出现，在局域网领域基本上都是采用双绞线作为传输媒体



### 02 双绞线

![image-20230222111430019](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230222111430019.png)



### 03 光纤

<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230222111619188.png" alt="image-20230222111619188" style="zoom: 50%;" />

- 纤芯直径
  - 多模光纤：$50\mu m、62.5\mu m$
  - 单模光纤：$9\mu m$
- 包层直径$125\mu m$
- 工作波长
  - $0.85\mu m(衰减较大)$
  - $1.30\mu m(衰减较小)$
  - $1.55\mu m(衰减较小)$

- 光纤的优点
  - 通信容量大（25000 ~ 30000GHz 的带宽）
  - 传输损耗小，远距离传输时更加经济
  - 抗雷电和电磁干扰性能好。这在大电流脉冲干扰的环境下尤为重要
  - 无串音干扰，保密性好，不易被窃听
  - 体积小，重量轻

- 光纤的缺点
  - 割接需要专用设备
  - 光电接口价格较贵

![image-20230222114738985](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230222114738985.png)

![image-20230222114847938](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230222114847938.png)

- 在发送端，可以采用发光二极管或半导体激光器作为光源
- 在接收端，可以采用光电二极管或激光检波器检测光脉冲

![image-20230222115149099](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230222115149099.png)

-  当光从高折射率的媒体射向低折射率的媒体时，其折射角将大于入射角
- 因此，如果入射角足够大，就会出现全反射，即光碰到包层时，就会反射回纤芯

![image-20230222115508597](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230222115508597.png)

- 实际上，只要从纤芯中射到纤芯表面的光纤的入射角大于某一个临界角度就可产生全反射
- 因此，可以存在许多条不同角度入射的光纤在一条光纤中传输，这种光纤称为**多模光纤**

![image-20230222115904087](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230222115904087.png)

![image-20230222120047357](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230222120047357.png)



### 04 电力线

<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230222120238521.png" alt="image-20230222120238521" style="zoom: 25%;" />

> 目前，如果要构建家庭高性能局域网，采用电力线作为传输媒体是不能满足要求的

**应用场景**

- 装修时，没有进行网络布线的家庭，可以采用这种方式
- 对于一些采用独立房间进行办公的企业来说，每间办公室的电脑数量不多，而又不希望跨办公室进行布线，也可以采取这种方式，每个办公室只需采取需求，在电源插座上插入一个或多个电力猫即可



### 05 无线电波

![image-20230222125138097](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230222125138097.png)

- 无线电波中的中频和低频片段主要利用地面波进行传输
- 高频和甚高频是利用电离层的反射

![image-20230222125417854](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230222125417854.png)



### 06 微波

![image-20230222130016715](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230222130016715.png)

- 微波通信在数据通信中占有重要地位，频率范围为 $300MHz \sim 300GHz(波长为1m \sim 1mm)$，但主要使用 $2\sim 40GHz$ 的频率范围，微波在空间中主要是直线传播

  > 由于微波会穿透电离层而进入宇宙空间，因此它不能经过电离层的反射传播到地面上很远的地方

- 传统的微波通信主要有两种方式

  - 地面微波接力通信
  - 卫星通信

- 微波在空间是直线传播的，而地球表面是一个曲面，因此其传播距离收到限制（一般只有 50 公里左右），但若采用 100m 高的天线塔，则传播距离可增大到 100 公里

  >为实现远距离通信，必须在一条微波通信信道的两个终端之间建立若干个中继站，中继站把前一站送来的信号经过放大后再发送到下一站，故称为 "接力"

- 常用的卫星通信方法是在地球站之间利用位于约 3 万 6 千公里的人造同步地球卫星作为中继器的一种微波接力通信，其最大特点是通信距离远，相应地，传播时延也比较大，一般在$250 \sim 300ms$之间

- 除同步卫星外，低轨道卫星通信系统已经在开始在空间部署，并构成了空间高速链路



### 07 红外线

![image-20230222192850482](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230222192850482.png)

- 很多家用电器（例如：电视、空调等）都配套有红外遥控器
- 以前的笔记本电脑基本都带有红外接口，可以进行红外通信

- 红外线通信具有以下特点：
  - 点对点无线传输
  - 直线传输，中间不能有障碍物，传输距离短
  - 传输速率低（$4Mb/s \sim 16Mb/s$）
- 现在笔记本电脑已经淘汰了红外接口，但是很多智能手机还带有红外接口，以方便用户对电视、空掉等家用电器进行红外遥控



### 08 可见光

我们现在通常都是用 WIFI 进行无线通信，但是现在有一种更加先进技术，即 LIFI（可见光技术或光保真技术，全称为 "Light Fidelity"）

利用电信号控制发光二极管（LED）发出肉眼看不到的高速闪烁信号来传输信息，这种技术做成的系统能够覆盖室内灯光达到的范围，电脑不需要电线连接只要在室内开启电灯，无需WIFI也可接入互联网。 

> 但是 LIFI 技术目前仍然在测试阶段，还未真正地大量投入使用



:spiral_notepad:**补充**

要使用某一段无线电频谱进行通信，通常必须得到本国政府有关电频谱管理机构的许可证，以下是一些国家的电频谱管理机构：

- 中国：工业和信息化部无线电管理局（国家无线电办公室）

- 美国：联邦通讯委员会 FCC

- 也有一些无线电频段是可以自由使用的，称为 ISM （Industrial ,Scientific, Medical）频段，以下是美国 ISM 频段

  ![image-20230222200711749](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230222200711749.png)

  > 各国的 ISM 标准可能略有所不同



## 6.3 传输方式

### 6.3.1 串行传输和并行传输

- 串行传输：是指数据是一个比特一个比特依次发送的。因此，在发送端与接收端之间只需要一条数据传输线路即可
- 并行传输：是指一次发送 n 个比特，而不是一个比特。为此，在发送端与接收端之间需要有 n 条传输线路

![image-20230222201328383](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230222201328383.png)

并行传输的传输速度是串行传输传输速度的 n 倍，但是成本过高，所以<strong style="color:red">在计算机网络中，数据在传输线路上的传输，采用的是串行传输，而计算机内部的数据传输，常采用并行传输的方式</strong>

> 最典型的例子便是：CPU 与内存在总线上的数据传输属于并行传输，常见的数据总线宽度有 8bit、16bit、32bit、64bit，目前主流是 64bit，其他总线宽度的计算机已经快被淘汰



### 6.3.2 同步传输和异步传输

- 同步传输：数据块以稳定的比特流的形式传输，字节之间没有间隔，接收端在每个比特信号的中间时刻进行检测，以判别接收到的是比特 0 还是比特 1

  ![image-20230222202816225](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230222202816225.png)

  > 由于不同设备的时钟频率存在一定差异，在传输大量数据的过程中，所产生的判别时刻的**累计误差**，会导致接收端对比特信号的判别错位，因此需要采取方法使收发双发的时钟保持同步，实现收发双发时钟同步的方法主要有以下两种：
  >
  > - 外同步：在收发双发之间添加一条单独的时钟信号线
  >   - 发送端在发送数据信号的同时，另外发送一路时钟同步信号，接收端按照时钟同步信号的节奏来接受数据
  > - 内同步：发送端将时钟同步信号编码到发送数据中一起传输（例如曼彻斯特编码）

- 异步传输：以字节为独立的传输单位，字节之间的时间间隔不是固定的，接收端仅在每个字节的起始处对字节内的比特实现同步。为此，通常要在每个字节的前后分别加上起始位和结束位

  ![image-20230222204006506](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230222204006506.png)

  - 字节之间异步（字节之间的时间间隔是不固定的）
  - 字节中的每个比特仍然要保持同步（各比特的持续时间是相同的）



### 6.3.3 单工、半双工和全双工

- 单工通信：又称为单向通信，通信双方只有一个数据传输方向

  > 例如：无线电广播采用的就是单工通信

- 半双工通信：又称为双向交替通信，通信双方可以相互传输数据，但不能同步进行

  > 例如：对讲机采用的就是半双工通信方式

- 全双工通信：即双向同时通信，通信双方可以同时发送和接收信息

  > 例如：电话采取的就是全双工通信

![image-20230222204623839](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230222204623839.png)

> 注：单向通信只需要一条信道，而双向交替通信或双向同时通信则需要两条信道（每个方向各一条）



## 6.4 编码和调制

在计算机网络中，计算机需要处理和传输用户的<u>文字、图片、音频和视频</u>，可以统称为消息。

- <strong style="color:red">数据是运送消息的实体</strong>，人类比较熟悉十进制数据，而计算机只能处理二进制数据，也就是比特 0 和比特 1

- 计算机中的网卡将比特 0 和比特 1变换成相应的电信号发送到网线，也就是说，<strong style="color:red">信号是数据的电磁表现</strong>

- <strong style="color:red">由信源发出的原始电信号称为基带信号</strong>，基带信号又可以分为两类：

  - 数字基带信号：例如计算机内部 CPU 与内存之间传输的信号
  - 模拟基带信号：例如麦克风收到声音后产生的音频信号

- 信号需要在信道中进行传输，信道可以分为两类：**数字信道和模拟信道**，在不改变信号性质的前提下，<strong style="color:red">仅对数字基带信号的波形进行变换，称为编码</strong>，编码后产生的信号仍然为数字信号，可以在数字信带中进行传输

  > 例如：以太网使用曼彻斯特编码、4B/5B、8B/10B 等编码

- 把数字基带信号的频率范围搬移到较高的频段并转换为模拟信号，称为**调制**，调制后产生的信号是模拟信号，可以在模拟信道中传输

  > 例如：WIFI 使用补码键控、直接序列扩频、正交频分复用等调制方法

- 对于模拟基带信号的处理，也有**编码和调制**两种方法

  - 对模拟基带信号进行编码的典型应用：对音频信号进行编码的脉码调制 PCM，也就是对模拟基带信号通过<u>采样、量化、编码</u>这三个步骤进行数字化
  - 对模拟基带信号进行调制的典型应用：将语音数据加载到模拟的载波信号中传输。例如传统的电话和频分复用 FDM 技术

![image-20230222220324736](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230222220324736.png)

**码元**

在使用时间域的波形表示数字信号时，<strong style="color:red">代表不同的离散数值的基本波形</strong>

<img src="https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230222220955284.png" alt="image-20230222220955284" style="zoom:50%;" />



**传输媒体和信道之间的关系**

严格意义上，传输媒体 ≠ 信道，对于单工传输，传输媒体中只包含一个信道，要么是发送信道，要么是接收信道，而对于半双工和全双工传输，传输媒体中主要包含两个信道，**一个是发送信道，另一个是接收信道**，如果使用信道复用技术，一条传输媒体还可以包含多个信道

![image-20230222230531002](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230222230531002.png)

**常用编码**

**01 不归零编码**

![image-20230222230916539](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230222230916539.png)

所谓"不归零"就是指<strong style="color:red">在整个码元时间内，电平不会出现零电平</strong>

:thought_balloon:**思考：接收方如何判断接收的信号段中有几个码元？**

答：使用<strong style="color:red">额外一根传输线来传输时钟信号</strong>使发送方和接收方保持同步，接收方按时钟信号的节拍来逐个接收码元，然而对于计算机网络，宁愿利用这根传输线传输数据信号，而不是传输时钟信号，所以**不归零编码存在同步问题**，计算机网络中的数据传输不使用这类编码。



**02 归零编码**

![image-20230222232650858](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230222232650858.png)

归零编码在<strong style="color:red">每个码元传输结束后信号都要 "归零"</strong>，所以接收方只要在信号归零后进行采样即可，不需要单独的时钟信号

- 实际上，归零编码相当于把时钟信号用 "归零" 的方式编码在了数据之内，这称为 "<strong style="color:red">自同步</strong>" 信号
- 但是，归零编码中大部分的数据带宽，都用来传输 "归零" 而浪费掉了
- 也就是说归零编码是**自同步，但是编码效率低**



**03 曼彻斯特编码**

![image-20230222233346696](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230222233346696.png)

- 在曼彻斯特编码中，<strong style="color:red">码元中间时刻的跳变既表示时钟，又表示数据</strong>
- 传统以太网使用的就是曼彻斯特编码，传输速度为 10Mb/s



**04 差分曼彻斯特编码**

![image-20230222233747129](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230222233747129.png)

对于差分曼彻斯特编码：

1. 跳变仅表示时钟
2. 码元开始处电平是否发生变化来表示数据

> 差分曼彻斯特编码变化少，更适合较高的传输速率



**习题**

![image-20230222234702211](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230222234702211.png)

> 10BaseT 中，10 表示传输速率为 10Mb/s，"Base" 表示基带传输，"T" 表示双绞线



**基本调制方法**

![image-20230222235414476](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230222235414476.png)

使用基本调制方法，1 个码元只能包含 1 个比特信息

因为<strong style="color:red">频率和相位是相关的</strong>，即频率是相位随时间的变化率。<strong style="color:red">所以一次只能调至频率和相位两个中的一个</strong>

通常情况下，相位和振幅可以结合起来一起调制，称为<strong style="color:red">正交振幅调制QAM</strong>



**混合调制举例 —— 正交振幅调制 QAM**

![image-20230223000517248](https://theblogimage.oss-cn-fuzhou.aliyuncs.com/imagefortypora/image-20230223000517248.png)

## 6.5 信道的极限容量

